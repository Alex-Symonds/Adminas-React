{% extends "adminas/layout.html" %}
{% load static %}

{% block title %}
    - Document Builder
{% endblock %}

{% block page_specific_css %}
    <link href="{% static 'adminas/styles/documents.css' %}" rel="stylesheet">
{% endblock %}

{% block javascript %}
    <script>
        const DOC_CODE = '{{ doc_type }}';
        const DOC_ID = '{{ doc_id }}';
        const JOB_ID = '{{ job_id }}';
        const JOB_URL = "{% url 'job' job_id %}";
        const URL_DOCBUILDER = "{% url 'api_draft_documents' %}";
        const URL_DOCMAIN = "{% url 'doc_main' doc_id %}"
        const URL_PREVIEW = "{% url 'doc_display' doc_id %}?mode=preview";
        const JOB_DOCTAB_URL = "{% url 'jobTabDocuments' job_id %}"
    </script>
    <script defer src="{% static 'adminas/scripts/docBuilder.bundle.js' %}" type="text/javascript"></script>
{% endblock %}



{% block body %}

    <h2 class="pageHeading">Document Builder</h2>
    <div class="subheading">{{ doc_title }}</div>
    <a class="return-to-job" href="{% url 'jobTabDocuments' job_id %}">&laquo; return to Job</a>

    <div class="pageContent documentPage"> 
        <h3 class="pageContent_header sectionHeading">
            <span class="pageContent_headerText">
                Working on document
            </span>
        </h3>
        <div class="documentPage_layout pageContent_content">

            <div class="documentPage_controlsAndWarningsWrapper">
                <div class="documentPage_controls">
                    <div class="documentPage_safeButtonsContainer">
                        <a 
{% if doc_id == 0 %}
                            href="{% url 'jobTabDocuments' job_id %}"
{% else %}
                            href="{% url 'doc_main' doc_id %}"
{% endif %}
                            class="closeIconTextButton"
                        >
                            <span class="closeIconTextButton_text">close</span>
                        </a>

                        <button 
                            class="saveIconTextButton"
                            disabled
                        >
                            <span class="saveIconTextButton_text">save</span>
                        </button>

                        <a  
                            href="{% url 'doc_display' doc_id %}"
                            class="previewIconTextButton {% if doc_id == 0 %}previewIconTextButton-disabled{% endif %}"
                        >
                            <span class="previewIconTextButton_text">preview</span>
                        </a>

                        <button 
                            class="issueFinalIconTextButton" 
                            {% if not is_valid or doc_id == 0 %}disabled{% endif %}
                        >
                            <span class="issueFinalIconTextButton_text">issue</span>
                        </button>
                    </div>

                    <div class="docBuilderControls_deleteButtonContainer">
                        <button 
                            class="deleteIconTextButton"
                            {% if doc_id == 0 %}disabled{% endif %}
                        >
                            <span class="deleteIconTextButton_text">delete</span>
                        </button>
                    </div>
                </div>

                <section class="documentPageWarnings documentWarnings">
                    <div class="documentPageWarnings_unsavedChanges documentPageWarnings_unsavedChanges-off">
                    </div>

                    {% if not is_valid %}
                    <section class="documentPageWarnings_invalid">
                        <h4>Invalid Item Quantities</h4>
                        <p>
                            JobItem quantities have altered since the draft document was created: there are no longer enough to fulfil all draft document assignments.
                        </p>
                    </section>
                    {% endif %}
                </section>
            </div>

            <section class="documentPageGeneral jobPanelSection">
                <h4 class="jobPanelSection_headingWrapper">
                    <span class="jobPanelSection_headingContent documentPageGeneral_headingContent">
                        General
                    </span>
                </h4>

                <div class="documentPageGeneral_formRow">
                    <label class="row-label" for="id_doc_reference">Reference</label>
                    <div class="documentPageGeneral_inputAndNoteWrapper">
                        <input class="subsection_input" type="text" id="id_doc_reference" value="{{reference}}">
                        <div class="doc-version" id="id_doc_version">version {{ version_number }}</div>
                    </div>
                </div>


            {% if doc_type == 'WO' %}
                <div class="documentPageGeneral_formRow">
                    <label class="row-label" for="id_req_prod_date">Requested Completion Date</label>
                    <input class="subsection_input" type="date" id="id_req_prod_date" value="{{doc_specific.date_requested|date:'Y-m-d'}}">
                </div>

                <div class="documentPageGeneral_formRow">
                    <label class="row-label" for="id_sched_prod_date">Scheduled Completion Date</label>
                    <input class="subsection_input" type="date" id="id_sched_prod_date" value="{{doc_specific.date_scheduled|date:'Y-m-d'}}">
                </div>
            {% endif %}
            </section>

            <section class="documentPageSpecialInstructions jobPanelSection">
                <h4 class="jobPanelSection_headingWrapper">
                    <span class="jobPanelSection_headingContent documentPageSpecialInstructions_headingContent">
                        Special Instructions
                    </span>
                </h4>
                <div class="documentPageSpecialInstructions_addButtonContainer">
                    <button class="add-button openCreateSpecialInstruction">special instruction</button>
                </div>

                <div class="modalWrapper hide addNewSpecialInstructionModal">
                    <dialog class="modal">
                        <button class="close modal_closeButton close-new-instr">
                            <span>close</span>
                        </button>
                            <h2 class="modal_heading">Special Instructions</h2>
                            <form class="documentPageSpecialInstructions_form" method="post" >
                                <label for="id_add_special_instruction" class="documentPageSpecialInstructions_label">Enter new special instruction</label>
                                <textarea id="id_add_special_instruction" class="documentPageSpecialInstructions_textarea"></textarea>
                                <div class="documentPageSpecialInstructions_controlsContainer">
                                    <button type="button" class="add-special-instruction-btn button-primary documentPageSpecialInstructions_button">add to pending</button>
                                </div>
                            </form>
                    </dialog>
                </div>
                
                <div class="existing">
            {% for sp_inst in special_instructions %}
                    <div class="documentPageSpecialInstructions_specialInstructionContainer" 
                        data-siid="{{ sp_inst.id }}"
                    >
                        <div class="documentPageSpecialInstructions_specialInstructionContents">{{ sp_inst.instruction }}</div>
                        <button class="documentPageSpecialInstructions_specialInstructionEditBtn edit-icon">
                            <span>edit</span>
                        </button>
                        <div class="documentPageSpecialInstructions_specialInstructionWhoAndWhen">
                            <span class="username">{{ sp_inst.created_by }}</span> on <span class="when">{{ sp_inst.created_on }}</span>
                        </div>
                    </div>
            {% empty %}
                    <p class="no-special-instructions empty-section-notice">No special instructions on this document</p>
            {% endfor %}
                </div>
            </section>


            <section class="documentPageItems jobPanelSection">
                <h3 class="jobPanelSection_headingWrapper">
                    <span class="jobPanelSection_headingContent documentPageItems_headingContent">
                        Items
                    </span>
                </h3>
                <div class="documentPageItems_content">

                    <div class="documentPageItems_included">
                        <h4 class="jobPanelSection_subsectionHeading documentPageItems_subsectionHeading">
                            Include
                        </h4>
                        <ul class="documentPageItems_itemsUl documentPageItems_itemsUl-included">
            {% for inc in included_items %}
                            <li 
                                data-jiid="{{ inc.jiid }}" 
                                class="documentPageItems_itemLi{% if inc.is_invalid %} documentPageItems_itemLi-invalid{% endif %}"
                                {% if inc.is_invalid %}data-max_available="{{ inc.max_available }}"{% endif %}
                            >
                                <span class="documentPageItems_itemDisplay">
                                    {% if inc.is_invalid %}<span class="invalid-icon"><span>quantity is invalid</span></span>{% endif %}
                                    <span class="documentPageItems_itemDisplayText">{{ inc.display }}</span>
                                </span>
                                <div class="documentPageItems_itemControls">
                                    <button
                                        class="documentPageItems_excludeButton"
                                    >
                                        <span class="hoverLabel">exclude</span>
                                    </button>
                {% if inc.max_available > 1 or inc.quantity > 1 and inc.is_invalid %}
                                    <button class="documentPageItems_splitButton">
                                        <span class="hoverLabel">split / join</span>
                                    </button>
                {% endif %}
                                </div>
                            </li>
            {% empty %}
                            <li class="documentPageItems_emptyLi none">None</li>
            {% endfor %}
                        </ul>
                    </div>
                    <div class="documentPageItems_excluded">
                        <h4 class="jobPanelSection_subsectionHeading documentPageItems_subsectionHeading">
                            Exclude
                        </h4>
                        <ul class="documentPageItems_itemsUl documentPageItems_itemsUl-excluded">
                {% for excl in excluded_items %}
                            <li 
                                data-jiid="{{ excl.jiid }}"
                                class="documentPageItems_itemLi documentPageItems_itemLi-excluded{% if excl.is_available == False %} documentPageItems_itemLi-unavailable{% endif %}"
                            >
                                <span class="documentPageItems_itemDisplay">
                                    {% if excl.is_invalid %}<span class="invalid-icon"><span>quantity is invalid</span></span>{% endif %}
                                    <span class="documentPageItems_itemDisplayText">{{ excl.display }}</span>
                    {% if excl.is_available %}
                                </span>
                                <div class="documentPageItems_itemControls">
                                    <button class="documentPageItems_includeButton">
                                        <span class="hoverLabel">include</span>
                                    </button>
                        {% if excl.total_quantity > 1 %}
                                    <button class="documentPageItems_splitButton">
                                        <span class="hoverLabel">split / join</span>
                                    </button>
                        {% endif %}
                                </div>
                    {% else %}
                                <span><a href="{% url 'doc_editor_page' %}?id={{excl.doc_id}}">
                                    (on&nbsp;{% if excl.used_by %}{{ excl.used_by }}{% else %}unnamed{% endif %})
                                </a></span>
                                </span>
                    {% endif %}
                            </li>
                {% empty %}
                            <li class="documentPageItems_emptyLi none">None</li>
                {% endfor %}                
                        </ul>
                    </div>

                </div>
            </section>
        </div>
    </div>


{% endblock %}