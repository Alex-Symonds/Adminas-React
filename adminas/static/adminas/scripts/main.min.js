const QTY_RE=/\d+(?=( x ))/g,CLASS_MESSAGE_BOX="system-message-box",CLASS_ERROR_MESSAGE="temp-warning-msg",CSS_GENERIC_PANEL="panel",CSS_GENERIC_PANEL_HEADING="panel-header",CSS_GENERIC_FORM_LIKE="form-like",CSS_EDIT_ICON="edit-icon",CSS_HIDE="hide",KEY_RESPONSE_ERROR_MSG="error",KEY_HTTP_CODE="http_code",KEY_LOCATION="location",GOOD_RESPONSE_CODES=new Set([200,201,204]),RETURN_ERROR=-1;function get_request_options(e,t=null){let n={method:e,headers:getDjangoCsrfHeaders(),credentials:"include"};return null!=t&&(n.body=JSON.stringify(t)),n}function getDjangoCsrfHeaders(){var e=getCookie("csrftoken"),t=new Headers;return t.append("X-CSRFToken",e),t}function getCookie(t){let n=null;if(document.cookie&&""!==document.cookie){const _=document.cookie.split(";");for(let e=0;e<_.length;e++){const o=_[e].trim();if(o.substring(0,t.length+1)===t+"="){n=decodeURIComponent(o.substring(t.length+1));break}}}return n}async function update_backend(e,t){return get_json_with_status(await fetch(e,t).catch(e=>{console.log("Error: ",e)}))}async function query_backend(e){return get_json_with_status(await fetch(e).catch(e=>{console.log("Error: ",e)}))}async function get_json_with_status(e){const t=e.headers.get("content-type");var n;return(n=t&&-1!==t.indexOf("application/json")?await e.json():{})[KEY_HTTP_CODE]=e.status,n[KEY_LOCATION]=e.headers.get("Location"),n}function status_is_good(e,t=null){e=get_status_from_json(e);return e!==RETURN_ERROR&&(null===t?GOOD_RESPONSE_CODES.has(e):e===t)}function get_status_from_json(e){return"object"==typeof e&&KEY_HTTP_CODE in e?"string"==typeof e[KEY_HTTP_CODE]?parseInt(e[KEY_HTTP_CODE]):e[KEY_HTTP_CODE]:RETURN_ERROR}function get_error_message(t,n=null){if("string"==typeof t)return t;if("object"!=typeof t)return null!==n?n:"Error: something went wrong.";if(null!==n){let e=!0;var _=get_status_from_json(t);if(e=_!==RETURN_ERROR?!prefer_response_error_to_task_error(_):e)return n}return get_error_message_from_response(t)}function prefer_response_error_to_task_error(e){return!!GOOD_RESPONSE_CODES.has(e)||(401==e||403==e||409==e)}function get_error_message_from_response(e){if(status_is_good(e))return"Page refresh recommended.";switch(get_status_from_json(e)){case 400:return"Invalid inputs.";case 401:return"You must be logged in.";case 403:return responded_with_error_reason(e)?e[KEY_RESPONSE_ERROR_MSG]:"Request was forbidden by the server.";case 404:return"Requested information was not found.";case 409:return responded_with_error_reason(e)?e[KEY_RESPONSE_ERROR_MSG]:"Request clashed with information on server. (The server won.)";case 500:return"A server error has occurred.";default:return"Error: something went wrong."}}function responded_with_error_reason(e){return"object"==typeof e&&KEY_RESPONSE_ERROR_MSG in e}function get_date_time(){let e=new Date;return e.toLocaleString("en-GB")}function string_to_boolean(e){return"string"!=typeof e?null:"boolean"==typeof e?e:"true"===(e=e.toLowerCase())||"false"!==e&&null}function hide_all_by_class(e){document.querySelectorAll("."+e).forEach(e=>{e.classList.add(CSS_HIDE)})}function unhide_all_by_class(e){document.querySelectorAll("."+e).forEach(e=>{e.classList.remove(CSS_HIDE)})}function get_ele_index(t,e){let n=-1;if(t&&e){var _=[...e.children];for(let e=0;e<_.length;++e)if(_[e]==t){n=e;break}}return n}function add_event_listener_if_element_exists(e,t){null!==e&&e.addEventListener("click",t)}function create_generic_ele_dismissable_error(e,t=null){let n=document.createElement("div"),_=(n.classList.add(CLASS_ERROR_MESSAGE),document.createElement("div")),o=(_.innerHTML=get_error_message(e,t),n.append(_),create_generic_ele_cancel_button());return o.addEventListener("click",e=>{e.target.closest("."+CLASS_ERROR_MESSAGE).remove()}),n.append(o),n}function display_document_response_message(e,t=!1){let n=document.querySelector(".status-controls"),_=document.querySelector("."+CLASS_MESSAGE_BOX);null==_&&(_=create_generic_ele_message(),n.append(_));let o;o="string"==typeof e?(t&&_.classList.add(CLASS_ERROR_MESSAGE),e):"message"in e?e.message:responded_with_error_reason(e)?(_.classList.add(CLASS_ERROR_MESSAGE),`Error: ${get_error_message(e)} @ `+get_date_time()):(_.classList.add(CLASS_ERROR_MESSAGE),"Something went wrong, try refreshing the page"),_.innerHTML=o+" @ "+get_date_time()}function create_generic_ele_message(){let e=document.createElement("div");return e.classList.add(CLASS_MESSAGE_BOX),e}function create_generic_ele_label(e,t){let n=document.createElement("label");return n.innerHTML=e,n.for=t,n}function create_generic_ele_checkbox(e,t=!1){let n=document.createElement("input");return n.type="checkbox",n.id=e,t&&(n.checked=!0),n}function create_generic_ele_cancel_button(){let e=document.createElement("button"),t=(e.classList.add("close"),document.createElement("span"));return t.innerHTML="close",e.append(t),e}function create_generic_ele_submit_button(){let e=document.createElement("button");return e.classList.add("button-primary"),e.innerHTML="submit",e}function create_generic_ele_delete_button(){let e=document.createElement("button");return e.innerHTML="delete",e.classList.add("button-warning"),e.classList.add("delete-btn"),e}function create_generic_ele_edit_button(){let e=document.createElement("button"),t=(e.classList.add(CSS_EDIT_ICON),document.createElement("span"));return t.innerHTML="edit",e.append(t),e}function create_generic_ele_jobitem_quantity_input(){let e=document.createElement("input");return e.type="number",e.name="qty",e.id="id_qty",e.required=!0,e.min=1,e}function create_generic_ele_panel(){let e=document.createElement("div");return e.classList.add(CSS_GENERIC_PANEL),e}function create_generic_ele_formy_panel(){let e=create_generic_ele_panel();return e.classList.add(CSS_GENERIC_FORM_LIKE),e}const ATTR_LABEL_FORM_TYPE="data-form_type",CLASS_ADD_BUTTON="add-button",CLASS_ADD_BUTTON_COMMENT=CLASS_ADD_BUTTON+".addComment",CLASS_EMPTINESS_MESSAGE="empty-section-notice",CLASS_COMMENT="one-comment",CLASS_COMMENT_CONTENTS="contents",CLASS_COMMENT_CONTROLS="controls",CLASS_COMMENT_EDIT_BTN="edit-comment",CLASS_COMMENT_EDITOR="job-comment-cu-container",CLASS_COMMENT_FOOTER="footer",CLASS_COMMENT_HIGHLIGHTED_TOGGLE="highlighted-toggle",CLASS_COMMENT_INPUT_CHECKBOX_CONTAINER="checkbox-container",CLASS_COMMENT_MAIN="main",CLASS_COMMENT_OWNERSHIP="ownership",CLASS_COMMENT_PINNED_TOGGLE="pinned-toggle",CLASS_COMMENT_SECTION="comments",CLASS_COMMENTS_CONTAINER="comment-container",CLASS_COMMENTS_CONTAINER_HIGHLIGHTED="highlighted",CLASS_COMMENTS_CONTAINER_PINNED="pinned",CLASS_CREATE_COMMENT_CONTAINER="create-comments-container",CLASS_HIGHLIGHTED_COMMENT="highlighted",CLASS_PINNED_TOGGLE="pinned-toggle",CLASS_PINNED_BTN_ON="pin-on",CLASS_PINNED_BTN_OFF="pin-off",CLASS_PREFIX_FOR_COMMENT_ID="id-",CLASS_PRIVACY_STATUS="privacy-status",CLASS_SAVE_BTN="save",CLASS_TODO_HAS_JOB_ID="todoJob",DEFAULT_COMMENT_ID="0",ID_COMMENT_TEXTAREA="id_comment_contents",ID_COMMENT_CHECKBOX_HIGHLIGHTED="id_highlighted_checkbox",ID_COMMENT_CHECKBOX_PINNED="id_pinned_checkbox",ID_COMMENT_CHECKBOX_PRIVATE="id_private_checkbox",ID_PREFIX_JOB_PANEL_ON_TODO_LIST="todo_panel_job_",KEY_COMMENT_OWNERSHIP_STRING="footer_str",STR_FALLBACK="???",TASK_CREATE_COMMENT="create",VALUE_FORM_TYPE_CONTENT_ONLY="content-only",VALUE_FORM_TYPE_FULL="full";function open_jobcomment_editor_for_update(e){close_jobcomment_editor();let t=e.closest("."+CLASS_COMMENT);e=populate_ele_jobcomment_editor_with_existing(create_ele_jobcomment_editor(t.dataset.comment_id,!0),t,!1);t.prepend(e),update_visibility_comment_content(t,!1)}function close_jobcomment_editor(){let e=document.querySelector("."+CLASS_COMMENT_EDITOR);var t;null!=e&&(t=e.closest("."+CLASS_COMMENT),e.remove(),null!=t&&update_visibility_comment_content(t,!0),update_visibility_add_comment_button(!0),unhide_all_by_class(CLASS_COMMENT_EDIT_BTN))}function create_ele_jobcomment_editor(e,t,n=null){var n=get_settings_jobcomment_editor(n),_=VALUE_FORM_TYPE_CONTENT_ONLY;let o=create_ele_jobcomment_editor_base();return o.append(create_ele_jobcomment_editor_close_button(t)),o.append(create_ele_jobcomment_editor_heading(n.title)),o.append(create_ele_jobcomment_editor_contents_input()),o.append(create_ele_jobcomment_editor_controls_container(e,_,n.save_funct)),o}function get_settings_jobcomment_editor(e){return e===TASK_CREATE_COMMENT?{title:"Add Comment",save_funct:save_new_job_comment}:{title:"Edit Comment",save_funct:save_updated_job_comment}}function create_ele_jobcomment_editor_base(){let e=document.createElement("div");return e.classList.add(CLASS_COMMENT_EDITOR),e.classList.add(CSS_GENERIC_PANEL),e.classList.add(CSS_GENERIC_FORM_LIKE),e}function create_ele_jobcomment_editor_heading(e){let t=document.createElement("h4");return t.innerHTML=e,t}function create_ele_jobcomment_editor_contents_input(){let e=document.createElement("textarea");return e.name="contents",e.id=ID_COMMENT_TEXTAREA,e.cols=30,e.rows=5,e}function create_ele_jobcomment_editor_controls_container(e,t,n){let _=document.createElement("div");return _.classList.add(CLASS_COMMENT_CONTROLS),_.append(create_ele_jobcomment_editor_save_button(e,t,n)),e!=DEFAULT_COMMENT_ID&&_.append(create_ele_jobcomment_editor_delete_button()),_}function create_ele_jobcomment_editor_save_button(e,t,n){let _=create_generic_ele_submit_button();return _.classList.add(CLASS_SAVE_BTN),_.setAttribute("data-comment_id",e),_.setAttribute(ATTR_LABEL_FORM_TYPE,t),_.addEventListener("click",e=>{n(e.target)}),_}function create_ele_jobcomment_editor_close_button(e){let t=create_generic_ele_cancel_button();return e&&t.addEventListener("click",()=>{close_jobcomment_editor()}),t}function create_ele_jobcomment_editor_delete_button(){let e=create_generic_ele_delete_button();return e.addEventListener("click",e=>{delete_job_comment(e.target)}),e}function populate_ele_jobcomment_editor_with_existing(e,t){t=t.querySelector("."+CLASS_COMMENT_CONTENTS).innerHTML.trim();return e.querySelector("#"+ID_COMMENT_TEXTAREA).value=html_tags_to_newlines(t),e}function html_tags_to_newlines(e){return e=(e=(e=(e=(e=(e=(e="<p>"==e.slice(0,3)?e.slice(3):e).replaceAll("\n","")).replaceAll("</p>","")).replaceAll("<p>","\n\n")).replaceAll("<br>","\n")).replaceAll("<br/>","\n")).replaceAll("<br />","\n")}function newlines_to_html_tags(e){let t=e.replaceAll("\n\n","</p><p>");return(t=t.length!==e.length?"<p>"+(t="<p>"===t.slice(-3)?t.slice(0,-3):t)+"</p>":t).replaceAll("\n","<br>")}function update_visibility_comment_content(e,t){let n=e.querySelector(".wrapper");null!=n&&(visibility_element(e.querySelector(".wrapper"),t),t&&n.removeAttribute("open"))}function update_visibility_add_comment_button(e){(e?unhide_all_by_class:hide_all_by_class)(""+CLASS_ADD_BUTTON_COMMENT)}async function save_new_job_comment(e){let t=get_comment_data_from_editor(e);var n=await update_backend_comment(e,t,"POST");status_is_good(n,201)?(t.id=n.id,t[KEY_COMMENT_OWNERSHIP_STRING]="You on "+n.created_on_str,t.job_id=get_job_id_for_comments(e),update_job_comments_after_create(t)):update_job_comments_after_failed_create(n,e)}async function save_updated_job_comment(e){let t=get_comment_data_from_editor(e);var n=await update_backend_comment(e,t,"PUT","id="+e.dataset.comment_id);status_is_good(n,204)?(t.id=e.dataset.comment_id,t[KEY_COMMENT_OWNERSHIP_STRING]=get_ownership_string_from_existing_comment(e),t.job_id=get_job_id_for_comments(e),update_job_comments_after_update(t)):update_job_comments_after_failed_update(n,e)}async function delete_job_comment(e){var t=e.closest("."+CLASS_COMMENT),n=await update_backend_delete_comment(e,t.dataset.comment_id);status_is_good(n,204)?update_job_comments_after_delete(t.dataset.comment_id):update_job_comments_after_failed_update(n,e)}function get_comment_data_from_editor(e){return e.dataset.form_type==VALUE_FORM_TYPE_CONTENT_ONLY?get_comment_data_from_simplified_editor(e):get_comment_data_from_full_editor()}function get_comment_data_from_full_editor(){let e=get_default_comment_data();var t=document.getElementById(ID_COMMENT_CHECKBOX_PRIVATE),t=(null!=t&&(e.private=t.checked),document.getElementById(ID_COMMENT_CHECKBOX_PINNED)),t=(null!=t&&(e.pinned=t.checked),document.getElementById(ID_COMMENT_CHECKBOX_HIGHLIGHTED));return null!=t&&(e.highlighted=t.checked),e}function get_comment_data_from_simplified_editor(e){let t=get_default_comment_data();t.pinned=!0;e=e.closest("."+CLASS_COMMENT);return null!=e&&(t.private=string_to_boolean(e.dataset.is_private),t.pinned=string_to_boolean(e.dataset.is_pinned),t.highlighted=string_to_boolean(e.dataset.is_highlighted)),t}function get_default_comment_data(){return{contents:document.getElementById(ID_COMMENT_TEXTAREA).value,private:!0,pinned:!1,highlighted:!1}}async function update_backend_comment(e,t,n,_=null){e=get_jobcomments_url(e),n=get_request_options(n,format_comment_data_for_be(t));let o=null!==_?"&"+_:"";return update_backend(""+e+o,n)}async function update_backend_delete_comment(e,t){return update_backend(get_jobcomments_url(e)+"&id="+t,get_request_options("DELETE"))}function get_jobcomments_url(e){return"undefined"!=typeof URL_COMMENTS_WITH_JOB?URL_COMMENTS_WITH_JOB:e.closest("."+CLASS_COMMENT_SECTION).dataset.url_comments}function format_comment_data_for_be(e){return{contents:e.contents,private:e.private,pinned:e.pinned,highlighted:e.highlighted}}function get_job_id_for_comments(e){return void 0!==window.JOB_ID?window.JOB_ID:null!==(e=e.closest("."+CLASS_TODO_HAS_JOB_ID))?e.dataset.job_id:-1}function get_ownership_string_from_existing_comment(e){let t=e.closest("."+CLASS_COMMENT);return t.querySelector("."+CLASS_COMMENT_OWNERSHIP).innerHTML}function update_job_comments_after_create(e){close_jobcomment_editor();var t=get_class_to_find_comment(e.id);e.pinned&&add_comment_to_section(t,CLASS_COMMENTS_CONTAINER_PINNED,e),remove_all_jobcomment_warnings(),update_todo_list_row_pinned(e,"create")}function update_job_comments_after_update(t){close_jobcomment_editor(),document.querySelectorAll("."+CLASS_PREFIX_FOR_COMMENT_ID+t.id).forEach(e=>{update_comment_ele(t,e)}),update_comment_presence_in_one_filtered_section(response,"pinned"),update_todo_list_row_pinned(t,"update")}function update_job_comments_after_delete(e){document.querySelectorAll("."+CLASS_PREFIX_FOR_COMMENT_ID+e).forEach(e=>{var t=e.closest("."+CLASS_COMMENTS_CONTAINER);e.remove(),handle_section_emptiness(t)}),update_todo_list_row_pinned({id:e},"delete")}function update_job_comments_after_failed_create(e,t){t=t.closest("."+CLASS_CREATE_COMMENT_CONTAINER),close_jobcomment_editor(),remove_all_jobcomment_warnings(),e=create_generic_ele_dismissable_error(e);add_error_comment_creation_failed(e,t)}function update_job_comments_after_failed_update(e,t){let n=t.closest("."+CLASS_COMMENT),_=(close_jobcomment_editor(),n.querySelector(".contents"));t=create_generic_ele_dismissable_error(e);_.prepend(t)}function add_error_comment_creation_failed(e,t){let n=t.parentElement;var _=n.querySelector("."+CLASS_COMMENTS_CONTAINER),o=get_ele_index(t,n),_=get_ele_index(_,n);let r=t.querySelector("."+CLASS_ADD_BUTTON);_<o&&-1!=_?r.before(e):r.after(e)}function create_ele_comment(e){let t=create_ele_comment_base(e);return t.append(create_ele_comment_contents_wrapper(e)),add_event_listeners_to_comment_icons(t),t}function create_ele_comment_base(e){let t=document.createElement("article");return t.classList.add(CLASS_COMMENT),t.classList.add(""+CLASS_PREFIX_FOR_COMMENT_ID+e.id),e.highlighted&&t.classList.add(CLASS_HIGHLIGHTED_COMMENT),t.setAttribute("data-comment_id",e.id),t.setAttribute("data-is_private",e.private),t.setAttribute("data-is_pinned",e.pinned),t.setAttribute("data-is_highlighted",e.highlighted),t}function create_ele_comment_contents_wrapper(e){let t=document.createElement("details");return t.classList.add("wrapper"),t.append(create_ele_comment_body(e)),t.append(create_ele_comment_footer(e)),t}function create_ele_comment_body(e){let t=document.createElement("summary");return t.classList.add("comment-body"),t.append(create_ele_comment_body_contents(e.private,e.contents)),t}function create_ele_comment_body_contents(e,t){let n=document.createElement("span");return n.classList.add(CLASS_COMMENT_MAIN),e&&n.append(create_ele_comment_privacy_status()),n.append(create_ele_comment_contents(t)),n}function create_ele_comment_privacy_status(){let e=document.createElement("div");return e.classList.add(CLASS_PRIVACY_STATUS),e.innerHTML="[PRIVATE]",e}function create_ele_comment_contents(e){let t=document.createElement("span");return t.classList.add(CLASS_COMMENT_CONTENTS),t.innerHTML=newlines_to_html_tags(e),t}function create_ele_comment_footer(e){let t=document.createElement("section");return t.classList.add(CLASS_COMMENT_FOOTER),t.append(create_ele_comment_ownership(e)),t.append(create_ele_comment_controls(e)),t}function create_ele_comment_ownership(e){let t=document.createElement("div"),n=(t.classList.add(CLASS_COMMENT_OWNERSHIP),"Unknown user at unknown time");return KEY_COMMENT_OWNERSHIP_STRING in e?n=e[KEY_COMMENT_OWNERSHIP_STRING]:"created_by"in e&&"created_on_str"in e&&(n=e.created_by+" on "+e.created_on_str),t.innerHTML=n,t}function create_ele_comment_controls(e){let t=document.createElement("div");return t.classList.add(CLASS_COMMENT_CONTROLS),t.append(create_ele_comment_pinned_button(e.pinned)),t.append(create_ele_comment_highlight_button()),t.append(create_ele_comment_edit_button()),t}function create_ele_comment_pinned_button(e){e=get_settings_comment_pinned_button(e);let t=create_ele_comment_icon_button(e.display_str,CLASS_PINNED_TOGGLE);return t.classList.add(e.css_class),t}function create_ele_comment_highlight_button(){return create_ele_comment_icon_button("+/- highlight",CLASS_COMMENT_HIGHLIGHTED_TOGGLE)}function create_ele_comment_edit_button(){return create_ele_comment_icon_button("edit",CLASS_COMMENT_EDIT_BTN)}function get_settings_comment_pinned_button(e){return{display_str:e?"unpin":"pin",css_class:e?CLASS_PINNED_BTN_ON:CLASS_PINNED_BTN_OFF,unwanted_css_class:e?CLASS_PINNED_BTN_OFF:CLASS_PINNED_BTN_ON}}function create_ele_comment_icon_button(e,t){let n=document.createElement("button");return n.classList.add(t),n.innerHTML=e,n}function add_event_listeners_to_comment_icons(e){add_event_listener_if_element_exists(e.querySelector("."+CLASS_COMMENT_EDIT_BTN),e=>{open_jobcomment_editor_for_update(e.target)}),add_event_listener_if_element_exists(e.querySelector("."+CLASS_COMMENT_PINNED_TOGGLE),e=>{toggle_status(e.target,"pinned")}),add_event_listener_if_element_exists(e.querySelector("."+CLASS_COMMENT_HIGHLIGHTED_TOGGLE),e=>{toggle_status(e.target,"highlighted")})}function update_comment_presence_in_one_filtered_section(e,t){var n=""+CLASS_PREFIX_FOR_COMMENT_ID+e.id;e[t]?e[t]&&add_comment_to_section(n,t,e):remove_comment_from_section(n,t)}function update_comment_ele(e,t){let n=t.querySelector("."+CLASS_COMMENT_CONTENTS);n.innerHTML=newlines_to_html_tags(e.contents),update_ele_comment_pinned_status(t,e.pinned),update_ele_comment_highlighted_status(t,e.highlighted),update_ele_comment_private_status(t,e.private)}function get_class_to_find_comment(e){return""+CLASS_PREFIX_FOR_COMMENT_ID+e}function remove_all_jobcomment_warnings(){document.querySelectorAll("."+CLASS_ERROR_MESSAGE).forEach(e=>{e.remove()})}function visibility_element(e,t){var n;null!=e&&(n=!e.classList.contains(CSS_HIDE),t&&!n?e.classList.remove(CSS_HIDE):!t&&n&&e.classList.add(CSS_HIDE))}async function toggle_status(e,t){var n=e.closest("."+CLASS_COMMENT),_=get_comment_status_boolean(e,t),e=await update_backend_for_comment_toggle(get_jobcomments_url(e),n.dataset.comment_id,!_,t);status_is_good(e,204)?update_frontend_for_comment_toggle(n,!_,t):alert(get_error_message(e))}function get_comment_status_boolean(e,t){e=e.closest("."+CLASS_COMMENT);if(null!==e){if("pinned"===t)var n=e.dataset.is_pinned;else{if("highlighted"!==t)return;n=e.dataset.is_highlighted}return string_to_boolean(n)}}async function update_backend_for_comment_toggle(e,t,n,_){let o={};return o[_]=n,update_backend(e+"&id="+t,get_request_options("PUT",o))}function update_frontend_for_comment_toggle(e,t,n){var _=get_class_to_find_comment(e.dataset.comment_id);document.querySelectorAll("."+_).forEach(e=>{"pinned"==n?update_ele_comment_pinned_status(e,t):"highlighted"==n&&update_ele_comment_highlighted_status(e,t)}),(t?add_comment_to_section:remove_comment_from_section)(_,n),toggle_todo_list(e,t,n)}function update_ele_comment_pinned_status(e,t){e.setAttribute("data-is_pinned",t),update_comment_pinned_button(e.querySelector("."+CLASS_COMMENT_PINNED_TOGGLE),t)}function update_ele_comment_highlighted_status(e,t){e.setAttribute("data-is_highlighted",t);var n=e.classList.contains(CLASS_HIGHLIGHTED_COMMENT);t&&!n?e.classList.add(CLASS_HIGHLIGHTED_COMMENT):!t&&n&&e.classList.remove(CLASS_HIGHLIGHTED_COMMENT)}function update_ele_comment_private_status(t,e){t.setAttribute("data-is_private",e);let n=t.querySelector("."+CLASS_PRIVACY_STATUS);var _=null!==n;if(_&&!e)n.remove();else if(!_&&e){let e=t.querySelector("."+CLASS_COMMENT_MAIN);e.prepend(create_ele_comment_privacy_status())}}function update_comment_pinned_button(e,t){e.classList.contains(CLASS_PINNED_BTN_ON)!==t&&(t=get_settings_comment_pinned_button(t),e.classList.add(CLASS_PINNED_TOGGLE),e.classList.add(t.css_class),e.classList.remove(t.unwanted_css_class),e.innerHTML=t.display_str)}function add_comment_to_section(t,n,_=null){var o=document.querySelectorAll(`.${CLASS_COMMENTS_CONTAINER}.`+n);if(null!==o&&0!=o.length&&null!==(_=handle_missing_comment_data(_,t))){let e=find_comment_section_ele(o,_.job_id,n);null!==e&&null===e.querySelector("."+t)&&(o=create_ele_comment(_),e.prepend(o),handle_section_emptiness(e,n))}}function remove_comment_from_section(n,_){document.querySelectorAll(`.${CLASS_COMMENTS_CONTAINER}.`+_).forEach(e=>{let t=e.querySelector("."+n);null!==t&&(t.remove(),handle_section_emptiness(e,_))})}function handle_missing_comment_data(e,t){return null!==e?e:null!==(e=document.querySelector("."+t))?get_comment_data_from_comment_ele(e):null}function get_comment_data_from_comment_ele(e){let t={};return t.id=e.dataset.comment_id,t.footer_str=e.querySelector("."+CLASS_COMMENT_OWNERSHIP).innerHTML.trim(),t.contents=html_tags_to_newlines(e.querySelector("."+CLASS_COMMENT_CONTENTS).innerHTML.trim()),t.private="true"==e.dataset.is_private.toLowerCase(),t.pinned="true"==e.dataset.is_pinned.toLowerCase(),t.highlighted="true"==e.dataset.is_highlighted.toLowerCase(),t.job_id=get_job_id_for_comments(e),t}function find_comment_section_ele(t,n,_){if(1===t.length)return t[0];if(("number"==typeof n||"string"==typeof n)&&0<(n="string"==typeof n?parseInt(n):n)){t=""+ID_PREFIX_JOB_PANEL_ON_TODO_LIST+n;let e=document.getElementById(t);if(null!==e)return e.querySelector(`.${CLASS_COMMENTS_CONTAINER}.`+_)}return null}function handle_section_emptiness(e,t=STR_FALLBACK){var n=0===e.querySelectorAll("."+CLASS_COMMENT).length;const _=e.querySelector("."+CLASS_EMPTINESS_MESSAGE);n&&null===_?add_new_comment_emptiness_element(e,t):n||null===_||_.remove()}function add_new_comment_emptiness_element(e,t){t===STR_FALLBACK&&null!==(n=find_comment_section_name_in_classlist(e))&&(t=n);var n=create_ele_emptiness_explanation_for_comment_section(t);e.prepend(n)}function create_ele_emptiness_explanation_for_comment_section(e){let t=document.createElement("p");return t.classList.add(CLASS_EMPTINESS_MESSAGE),e==CLASS_COMMENTS_CONTAINER_HIGHLIGHTED||e==CLASS_COMMENTS_CONTAINER_PINNED?t.innerHTML="No comments have been "+e:t.innerHTML="No comments yet",t}function find_comment_section_name_in_classlist(t){var n=[CLASS_COMMENTS_CONTAINER_PINNED,CLASS_COMMENTS_CONTAINER_HIGHLIGHTED];for(let e=0;e<n.length;e++)if(t.classList.contains(n[e]))return n[e];return null}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("."+CLASS_COMMENT_EDIT_BTN).forEach(e=>{e.addEventListener("click",e=>{open_jobcomment_editor_for_update(e.target)})}),document.querySelectorAll("."+CLASS_COMMENT_PINNED_TOGGLE).forEach(e=>{e.addEventListener("click",e=>{toggle_status(e.target,"pinned")})}),document.querySelectorAll("."+CLASS_COMMENT_HIGHLIGHTED_TOGGLE).forEach(e=>{e.addEventListener("click",e=>{toggle_status(e.target,"highlighted")})})});const CLASS_REMOVE_JOB_BTN="todo-list-remove",CLASS_ADD_JOB_BTN="todo-list-add",ID_PREFIX_JOB_PANEL="todo_panel_job_",CLASS_TODO_ERROR_MSG="todo-error-message",CLASS_JOB_PANEL_DETAILS="job-details";async function remove_from_todo_list(e){var t=get_request_options("DELETE",{job_id:e.dataset.job_id}),t=await update_backend(""+URL_TODO_MANAGEMENT,t);clear_todo_error_from_job_panels(),status_is_good(t,204)?update_frontend_after_removal(e,e.dataset.job_id):display_todo_error_on_job_panel(t,e.dataset.job_id)||alert(get_error_message(t))}async function add_to_todo_list(e){var t=get_request_options("PUT",{job_id:e.dataset.job_id}),t=await update_backend(""+URL_TODO_MANAGEMENT,t);status_is_good(t,204)?update_frontend_after_add(e):alert(get_error_message(t))}function update_frontend_after_removal(e,t){e.classList.contains(CLASS_REMOVE_JOB_BTN)&&remove_job_panel_from_todo_list(t)}function update_frontend_after_add(e){var t="recordsTable_todoButton-on";if(e.classList.contains(CLASS_ADD_JOB_BTN)){e.disabled=!0,e.classList.remove("recordsTable_todoButton-off"),e.classList.contains(t)||e.classList.add(t);const n=e.querySelector(".recordsTable_todoButtonSpan");n.textContent="on todo list"}}function display_todo_error_on_job_panel(e,t){return!!(active_ele=document.querySelector("#"+ID_PREFIX_JOB_PANEL+t))&&(msg_ele=create_generic_ele_dismissable_error(e),active_ele.prepend(msg_ele),!0)}function clear_todo_error_from_job_panels(){document.querySelectorAll("."+CLASS_ERROR_MESSAGE).forEach(e=>{e.remove()})}function remove_job_panel_from_todo_list(e){null!=(ele_to_remove=document.querySelector("#"+ID_PREFIX_JOB_PANEL+e))&&ele_to_remove.remove()}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("."+CLASS_REMOVE_JOB_BTN).forEach(e=>{e.addEventListener("click",()=>{remove_from_todo_list(e)})}),document.querySelectorAll("."+CLASS_ADD_JOB_BTN).forEach(e=>{e.addEventListener("click",()=>{add_to_todo_list(e)})})});const ID_DOCUMENT_REPLACEMENT_BTN="replace_document_btn",ID_DOCUMENT_REVERT_BTN="revert_document_btn";async function replace_issued_document(){var e=get_request_options("POST"),e=await update_backend(`${URL_DOC_MAIN}?doc_id=${DOC_ID}&task=replace`,e);status_is_good(e,201)?window.location.href=e[KEY_LOCATION]:display_document_response_message(e)}async function revert_issued_document(){var e=get_request_options("POST"),e=await update_backend(`${URL_DOC_MAIN}?doc_id=${DOC_ID}&task=revert`,e);console.log(e),status_is_good(e,200)?window.location.href=e[KEY_LOCATION]:display_document_response_message(e)}async function update_address(e){let t=e.closest(".form-row").querySelector(".display-address");var n;0!=e.selectedIndex?status_is_good(e=await get_address_from_server(e.value))?(n=format_address(e),t.innerHTML=n):t.innerHTML=get_error_message(e):t.innerHTML=""}async function get_address_from_server(e){return get_json_with_status(await fetch(URL_SITE_ADDRESS+"?type=site_address&id="+e).catch(e=>{console.log("Error: ",e)}))}function format_address(e){var t=e.address.replaceAll(",","<br />"),t=add_str_and_br_if_not_blank(t+="<br />",e.region);return t=add_str_and_br_if_not_blank(t,e.postcode),add_str_and_br_if_not_blank(t,e.country)}function add_str_and_br_if_not_blank(e,t){return""!=t?e+(t+"<br />"):e}document.addEventListener("DOMContentLoaded",()=>{null!=(replace_btn=document.querySelector("#"+ID_DOCUMENT_REPLACEMENT_BTN))&&replace_btn.addEventListener("click",()=>{replace_issued_document()}),null!=(revert_btn=document.querySelector("#"+ID_DOCUMENT_REVERT_BTN))&&revert_btn.addEventListener("click",()=>{revert_issued_document()})}),CLASS_ADDRESS_DROPDOWN="address-dropdown",document.addEventListener("DOMContentLoaded",e=>{document.querySelectorAll("."+CLASS_ADDRESS_DROPDOWN).forEach(e=>{let t=e.querySelector("select");update_address(t),t.addEventListener("change",e=>{update_address(e.target)})})});const ID_DELETE_JOB_BTN="delete_job_btn";async function delete_job(){var e=get_request_options("DELETE"),e=await update_backend(URL_DELETE_JOB,e);204===get_status_from_json(e)?window.location.href="/":status_is_good(e)||display_delete_failed_message(e)}function display_delete_failed_message(t){var n=get_error_message(t);let _=document.querySelector("."+CLASS_ERROR_MESSAGE);if(null==_||_.getElementsByTagName("DIV")[0].innerHTML!=n){null!=_&&_.remove();let e=document.getElementById(ID_DELETE_JOB_BTN);n=create_generic_ele_dismissable_error(t);e.after(n)}}function animateAndThen(e,t,n=null){e&&(e.classList.add(t),e.onanimationend=()=>{e.classList.remove(t),n&&n()})}function openPinnedCommentsModal(e){e=e.target.closest("[data-target_id]").dataset.target_id;if(void 0===e)window.alert("Can't open pinned comments");else{const t=document.getElementById(e),n=(open_modal(t),t.querySelector(`.${CSS_MODAL}_`+CSS_CLOSE_BUTTON));void 0!==n&&n.addEventListener("click",()=>{t.classList.add(CSS_HIDE);const e=t.querySelector("."+CSS_MODAL);e&&e.close()})}}function toggle_todo_list(e,t,n){var _="pinned"!==n||t?"update":"unpin";const o={...get_comment_data_from_comment_ele(e),[n]:t};o.contents=newlines_to_spaces(o.contents),update_todo_list_row_pinned(o,_)}function update_todo_list_row_pinned(e,t){var n=find_pinned_button_which_opened_modal();null!==n&&(n.dataset.comment_id===e.id&&e.pinned||"create"===t?update_ele_todo_pinned_comment(n,e,n.dataset.jobName):"unpin"!==t&&"delete"!==t||update_ele_todo_pinned_comment(n,null!==(t=get_data_for_next_pinned_comment(e.id))?t:{id:DEFAULT_COMMENT_ID,contents:null,pinned:!0,highlighted:!1,private:!0},n.dataset.jobName))}function initialiseAnimatedAddCommentEditor(){const o="pinnedCommentsModal_addNewButton",r="pinnedCommentsModal_addNewContainer";function a(e){return e.closest("."+r)}document.querySelectorAll("."+o).forEach(_=>{_.addEventListener("click",()=>{{var e=_;close_jobcomment_editor();const t=create_ele_jobcomment_editor(DEFAULT_COMMENT_ID,!1,TASK_CREATE_COMMENT),n=t.querySelector(".close");n.addEventListener("click",()=>{animateAndThen(a(n),r+"-close",()=>{close_jobcomment_editor(),unhide_all_by_class(o)})}),e.after(t),hide_all_by_class(o)}animateAndThen(a(_),r+"-open",null)})})}function get_data_for_next_pinned_comment(t){const e=find_open_modal();if(is_pinned_comments_modal(e)){const _=e.querySelectorAll("."+CLASS_COMMENT);if(null!==_)for(let e=0;e<_.length;e++){var n=""+CLASS_PREFIX_FOR_COMMENT_ID+t;if(!_[e].classList.contains(n))return get_comment_data_from_comment_ele(_[e])}}return null}function find_pinned_button_which_opened_modal(){var e=find_open_modal();return is_pinned_comments_modal(e)?find_pinned_button_with_data_target_id(e.parentNode.id):null}function is_pinned_comments_modal(e){return null!==e&&e.classList.contains("pinnedCommentsModal")}function find_open_modal(){var t=document.querySelectorAll("."+CSS_MODAL);let n=null;for(let e=0;e<t.length;e++)if(t[e].open){n=t[e];break}return n}function find_pinned_button_with_data_target_id(t){var n=document.querySelectorAll(".pinnedModalOpener");let _=null;for(let e=0;e<n.length;e++)if(n[e].dataset.target_id===t){_=n[e];break}return _}function update_ele_todo_pinned_comment(e,t,n){e.setAttribute("data-comment_id",t.id);var _="todoJob_pinnedComment-empty",o="todoJob_pinnedComment-highlighted";null===t.contents||""===t.contents||void 0===t.contents?(e.classList.contains(_)||e.classList.add(_),e.classList.remove(o),e.replaceChildren(create_ele_todo_pinned_comment_contents("Click to add pinned comments"))):(t.highlighted?e.classList.contains(o)||e.classList.add(o):e.classList.remove(o),e.classList.remove(_),e.replaceChildren(create_ele_todo_pinned_comment_srButtonLabel(n),create_ele_todo_pinned_comment_privacyIcon(t.private),create_ele_todo_pinned_comment_contents(newlines_to_spaces(t.contents))))}function create_ele_todo_pinned_comment_srButtonLabel(e){const t=document.createElement("span");return t.className="sr-only",t.innerText="pinned comments for "+e,t}function create_ele_todo_pinned_comment_privacyIcon(e){const t=document.createElement("span");return t.classList.add("todoJob_pinnedPrivacyStatus"),t.classList.add("todoJob_pinnedPrivacyStatus-"+(e?"private":"public")),t.innerText=`[${e?"PRIVATE":"public"}]`,t}function create_ele_todo_pinned_comment_contents(e){const t=document.createElement("p");return t.className="todoJob_pinnedContents",t.innerText=e,t}function newlines_to_spaces(e){return e.replaceAll("\n"," ")}function closeOnClickOutside(e,t,n){e.composedPath().includes(t)||n()}document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById(ID_DELETE_JOB_BTN);null!=e&&e.addEventListener("click",()=>{delete_job()})}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".pinnedModalOpener").forEach(e=>{e.addEventListener("click",e=>openPinnedCommentsModal(e))}),initialiseAnimatedAddCommentEditor()}),document.addEventListener("DOMContentLoaded",()=>{const t="statusEle",n="statusEle_message",i="statusEle_message-hidden",s="statusEle_icon";function _(e){return!e.classList.contains(i)}function o(e){const a=m(e),c=u(a);_(c)||window.setTimeout(()=>{var e,t,n,_;function o(){l(n),document.removeEventListener("click",r)}function r(e){closeOnClickOutside(e,_,o)}d(),e=c,t=a,e.textContent=function(e){e=e.querySelector("."+s);return void 0===e.dataset.toggletip_content?"No details are available":e.dataset.toggletip_content}(t),e.classList.remove(i),n=c,_=a,document.addEventListener("click",r)},100)}function r(e){e=u(m(e));_(e)&&l(e)}function d(){document.querySelectorAll("."+n).forEach(e=>{_(e)&&l(e)})}function l(e){e.textContent="",e.classList.add(i)}function m(e){return e.target.classList.contains(t)?e.target:e.target.closest("."+t)}function u(e){if(null!=e)return e.querySelector("."+n);window.alert("Can't display status details, try the job page instead.")}d(),document.querySelectorAll("."+s).forEach(e=>{e.addEventListener("click",e=>o(e)),e.addEventListener("keydown",e=>{27===(e.keyCode||e.which)&&r(e),13===(e.keyCode||e.which)&&o(e)}),e.addEventListener("blur",e=>r(e))})});const CSS_MODAL="modal",CSS_MODAL_CLOSE_BUTTON="modal_closeButton",CSS_CLOSE_BUTTON="closeButton",CSS_MODAL_WRAPPER="modalWrapper",CSS_MODAL_HEADING="modal_heading",CSS_MODAL_CONTENTS="modal_contents";function create_generic_modal(e){const t=create_generic_modal_wrapper(),n=create_generic_modal_dialog(),_=create_generic_ele_cancel_button();return _.classList.add(CSS_MODAL+"_"+CSS_CLOSE_BUTTON),_.addEventListener("click",()=>{close_modal(n,t)}),n.append(_),n.append(e),t.append(n),t}function create_generic_modal_dialog(){let e=document.createElement("dialog");return e.classList.add(CSS_MODAL),e}function create_generic_modal_wrapper(){let e=document.createElement("div");return e.classList.add(CSS_MODAL_WRAPPER),e.classList.add(CSS_HIDE),e}function open_modal(e){e.classList.remove(CSS_HIDE);const t=e.querySelector("."+CSS_MODAL);t.show()}function close_modal(e,t=null){const n=null===t?findModalWrapperFromChild(e):t;n.classList.contains(CSS_HIDE)||n.classList.add(CSS_HIDE),e.close()}function findAllModalCloseButtons(){return document.querySelectorAll("."+CSS_MODAL_CLOSE_BUTTON)}function findModalDialogFromChild(e){return e.closest("."+CSS_MODAL)}function findModalDialogFromParent(e){return e.querySelector("."+CSS_MODAL)}function findModalWrapperFromChild(e){return e.closest("."+CSS_MODAL_WRAPPER)}function findModalWrapperFromParent(e){return e.querySelector("."+CSS_MODAL_WRAPPER)}function setupModalCloseButton(e){const t=findModalDialogFromChild(e);null!==t&&e.addEventListener("click",()=>{close_modal(t,null)})}