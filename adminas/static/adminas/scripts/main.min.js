const QTY_RE=/\d+(?=( x ))/g,CLASS_MESSAGE_BOX="system-message-box",CLASS_ERROR_MESSAGE="temp-warning-msg",CSS_GENERIC_PANEL="panel",CSS_GENERIC_PANEL_HEADING="panel-header",CSS_GENERIC_FORM_LIKE="form-like",CSS_EDIT_ICON="edit-icon",CSS_HIDE="hide",KEY_RESPONSE_ERROR_MSG="error",KEY_HTTP_CODE="http_code",KEY_LOCATION="location",GOOD_RESPONSE_CODES=new Set([200,201,204]),RETURN_ERROR=-1;function get_request_options(e,t=null){let _={method:e,headers:getDjangoCsrfHeaders(),credentials:"include"};return null!=t&&(_.body=JSON.stringify(t)),_}function getDjangoCsrfHeaders(){var e=getCookie("csrftoken"),t=new Headers;return t.append("X-CSRFToken",e),t}function getCookie(t){let _=null;if(document.cookie&&""!==document.cookie){const n=document.cookie.split(";");for(let e=0;e<n.length;e++){const o=n[e].trim();if(o.substring(0,t.length+1)===t+"="){_=decodeURIComponent(o.substring(t.length+1));break}}}return _}async function update_backend(e,t){return get_json_with_status(await fetch(e,t).catch(e=>{console.log("Error: ",e)}))}async function query_backend(e){return get_json_with_status(await fetch(e).catch(e=>{console.log("Error: ",e)}))}async function get_json_with_status(e){const t=e.headers.get("content-type");var _;return(_=t&&-1!==t.indexOf("application/json")?await e.json():{})[KEY_HTTP_CODE]=e.status,_[KEY_LOCATION]=e.headers.get("Location"),_}function status_is_good(e,t=null){e=get_status_from_json(e);return e!==RETURN_ERROR&&(null===t?GOOD_RESPONSE_CODES.has(e):e===t)}function get_status_from_json(e){return"object"==typeof e&&KEY_HTTP_CODE in e?"string"==typeof e[KEY_HTTP_CODE]?parseInt(e[KEY_HTTP_CODE]):e[KEY_HTTP_CODE]:RETURN_ERROR}function get_error_message(t,_=null){if("string"==typeof t)return t;if("object"!=typeof t)return null!==_?_:"Error: something went wrong.";if(null!==_){let e=!0;var n=get_status_from_json(t);if(e=n!==RETURN_ERROR?!prefer_response_error_to_task_error(n):e)return _}return get_error_message_from_response(t)}function prefer_response_error_to_task_error(e){return!!GOOD_RESPONSE_CODES.has(e)||(401==e||403==e||409==e)}function get_error_message_from_response(e){if(status_is_good(e))return"Page refresh recommended.";switch(get_status_from_json(e)){case 400:return"Invalid inputs.";case 401:return"You must be logged in.";case 403:return responded_with_error_reason(e)?e[KEY_RESPONSE_ERROR_MSG]:"Request was forbidden by the server.";case 404:return"Requested information was not found.";case 409:return responded_with_error_reason(e)?e[KEY_RESPONSE_ERROR_MSG]:"Request clashed with information on server. (The server won.)";case 500:return"A server error has occurred.";default:return"Error: something went wrong."}}function responded_with_error_reason(e){return"object"==typeof e&&KEY_RESPONSE_ERROR_MSG in e}function get_date_time(){let e=new Date;return e.toLocaleString("en-GB")}function string_to_boolean(e){return"string"!=typeof e?null:"boolean"==typeof e?e:"true"===(e=e.toLowerCase())||"false"!==e&&null}function hide_all_by_class(e){document.querySelectorAll("."+e).forEach(e=>{e.classList.add(CSS_HIDE)})}function unhide_all_by_class(e){document.querySelectorAll("."+e).forEach(e=>{e.classList.remove(CSS_HIDE)})}function get_ele_index(t,e){let _=-1;if(t&&e){var n=[...e.children];for(let e=0;e<n.length;++e)if(n[e]==t){_=e;break}}return _}function add_event_listener_if_element_exists(e,t){null!==e&&e.addEventListener("click",t)}function create_generic_ele_dismissable_error(e,t=null){let _=document.createElement("div"),n=(_.classList.add(CLASS_ERROR_MESSAGE),document.createElement("div")),o=(n.innerHTML=get_error_message(e,t),_.append(n),create_generic_ele_cancel_button());return o.addEventListener("click",e=>{e.target.closest("."+CLASS_ERROR_MESSAGE).remove()}),_.append(o),_}function display_document_response_message(e,t=!1){let _=document.querySelector(".status-controls"),n=document.querySelector("."+CLASS_MESSAGE_BOX);null==n&&(n=create_generic_ele_message(),_.append(n));let o;o="string"==typeof e?(t&&n.classList.add(CLASS_ERROR_MESSAGE),e):"message"in e?e.message:responded_with_error_reason(e)?(n.classList.add(CLASS_ERROR_MESSAGE),`Error: ${get_error_message(e)} @ `+get_date_time()):(n.classList.add(CLASS_ERROR_MESSAGE),"Something went wrong, try refreshing the page"),n.innerHTML=o+" @ "+get_date_time()}function create_generic_ele_message(){let e=document.createElement("div");return e.classList.add(CLASS_MESSAGE_BOX),e}function create_generic_ele_label(e,t){let _=document.createElement("label");return _.innerHTML=e,_.for=t,_}function create_generic_ele_checkbox(e,t=!1){let _=document.createElement("input");return _.type="checkbox",_.id=e,t&&(_.checked=!0),_}function create_generic_ele_cancel_button(){let e=document.createElement("button"),t=(e.classList.add("close"),document.createElement("span"));return t.innerHTML="close",e.append(t),e}function create_generic_ele_submit_button(){let e=document.createElement("button");return e.classList.add("button-primary"),e.innerHTML="submit",e}function create_generic_ele_delete_button(){let e=document.createElement("button");return e.innerHTML="delete",e.classList.add("button-warning"),e.classList.add("delete-btn"),e}function create_generic_ele_edit_button(){let e=document.createElement("button"),t=(e.classList.add(CSS_EDIT_ICON),document.createElement("span"));return t.innerHTML="edit",e.append(t),e}function create_generic_ele_jobitem_quantity_input(){let e=document.createElement("input");return e.type="number",e.name="qty",e.id="id_qty",e.required=!0,e.min=1,e}function create_generic_ele_panel(){let e=document.createElement("div");return e.classList.add(CSS_GENERIC_PANEL),e}function create_generic_ele_formy_panel(){let e=create_generic_ele_panel();return e.classList.add(CSS_GENERIC_FORM_LIKE),e}const ATTR_LABEL_FORM_TYPE="data-form_type",CLASS_ADD_BUTTON="add-button",CLASS_ADD_BUTTON_COMMENT=CLASS_ADD_BUTTON+".comment",CLASS_EMPTINESS_MESSAGE="empty-section-notice",CLASS_EMPTINESS_NOT_PERSISTENT="not-persistent",CLASS_EMPTINESS_PERSISTENT="persistent",CLASS_COMMENT="one-comment",CLASS_COMMENT_CONTENTS="contents",CLASS_COMMENT_CONTROLS="controls",CLASS_COMMENT_EDIT_BTN="edit-comment",CLASS_COMMENT_EDITOR="job-comment-cu-container",CLASS_COMMENT_FOOTER="footer",CLASS_COMMENT_HIGHLIGHTED_TOGGLE="highlighted-toggle",CLASS_COMMENT_INPUT_CHECKBOX_CONTAINER="checkbox-container",CLASS_COMMENT_MAIN="main",CLASS_COMMENT_OWNERSHIP="ownership",CLASS_COMMENT_PINNED_TOGGLE="pinned-toggle",CLASS_COMMENT_SECTION="comments",CLASS_COMMENTS_CONTAINER="comment-container",CLASS_COMMENTS_CONTAINER_ALL="all-comments",CLASS_COMMENTS_CONTAINER_HIGHLIGHTED="highlighted",CLASS_COMMENTS_CONTAINER_PINNED="pinned",CLASS_CREATE_COMMENT_CONTAINER="create-comments-container",CLASS_HIGHLIGHTED_CSS="highlighted",CLASS_JOB_PANEL="panel.job",CLASS_PINNED_TOGGLE="pinned-toggle",CLASS_PINNED_BTN_ON="pin-on",CLASS_PINNED_BTN_OFF="pin-off",CLASS_PREFIX_FOR_COMMENT_ID="id-",CLASS_PRIVACY_STATUS="privacy-status",CLASS_SAVE_BTN="save",CLASS_STREAMLINED_WANTED="streamlined",CLASS_TODO_HAS_JOB_ID="todoJob",DEFAULT_COMMENT_ID="0",ID_COMMENT_TEXTAREA="id_comment_contents",ID_COMMENT_CHECKBOX_HIGHLIGHTED="id_highlighted_checkbox",ID_COMMENT_CHECKBOX_PINNED="id_pinned_checkbox",ID_COMMENT_CHECKBOX_PRIVATE="id_private_checkbox",ID_PREFIX_JOB_PANEL_ON_TODO_LIST="todo_panel_job_",KEY_COMMENT_OWNERSHIP_STRING="footer_str",SECTION_NAMES=["all-comments","pinned","highlighted"],STR_FALLBACK="???",TASK_CREATE_COMMENT="create",VALUE_FORM_TYPE_CONTENT_ONLY="content-only",VALUE_FORM_TYPE_FULL="full";function open_jobcomment_editor_for_create(e){close_jobcomment_editor();var t=create_ele_jobcomment_editor(DEFAULT_COMMENT_ID,e.dataset.form_type!==VALUE_FORM_TYPE_CONTENT_ONLY,TASK_CREATE_COMMENT);e.after(t),update_visibility_add_comment_button(!1),hide_all_by_class(CLASS_COMMENT_EDIT_BTN)}function open_jobcomment_editor_for_update(e){close_jobcomment_editor();let t=e.closest("."+CLASS_COMMENT),_=t.closest("."+CLASS_COMMENTS_CONTAINER);e=!(null!=_&&_.classList.contains(CLASS_COMMENTS_CONTAINER_PINNED)),e=populate_ele_jobcomment_editor_with_existing(create_ele_jobcomment_editor(t.dataset.comment_id,e),t,e);t.prepend(e),update_visibility_comment_content(t,!1)}function close_jobcomment_editor(){let e=document.querySelector("."+CLASS_COMMENT_EDITOR);var t;null!=e&&(t=e.closest("."+CLASS_COMMENT),e.remove(),null!=t&&update_visibility_comment_content(t,!0),update_visibility_add_comment_button(!0),unhide_all_by_class(CLASS_COMMENT_EDIT_BTN))}function create_ele_jobcomment_editor(e,t,_=null){var _=get_settings_jobcomment_editor(_),n=t?VALUE_FORM_TYPE_FULL:VALUE_FORM_TYPE_CONTENT_ONLY;let o=create_ele_jobcomment_editor_base();return o.append(create_ele_jobcomment_editor_close_button()),o.append(create_ele_jobcomment_editor_heading(_.title)),o.append(create_ele_jobcomment_editor_contents_input()),t&&o.append(create_ele_jobcomment_editor_checkbox_container()),o.append(create_ele_jobcomment_editor_controls_container(e,n,_.save_funct)),o}function get_settings_jobcomment_editor(e){return e===TASK_CREATE_COMMENT?{title:"Add Comment",save_funct:save_new_job_comment}:{title:"Edit Comment",save_funct:save_updated_job_comment}}function create_ele_jobcomment_editor_base(){let e=document.createElement("div");return e.classList.add(CLASS_COMMENT_EDITOR),e.classList.add(CSS_GENERIC_PANEL),e.classList.add(CSS_GENERIC_FORM_LIKE),e}function create_ele_jobcomment_editor_heading(e){let t=document.createElement("h4");return t.innerHTML=e,t}function create_ele_jobcomment_editor_contents_input(){let e=document.createElement("textarea");return e.name="contents",e.id=ID_COMMENT_TEXTAREA,e.cols=30,e.rows=5,e}function create_ele_jobcomment_editor_checkbox_container(){let e=document.createElement("div");return e.classList.add(CLASS_COMMENT_INPUT_CHECKBOX_CONTAINER),e.append(create_generic_ele_label("Private",ID_COMMENT_CHECKBOX_PRIVATE)),e.append(create_generic_ele_checkbox(ID_COMMENT_CHECKBOX_PRIVATE,!0)),e.append(create_generic_ele_label("Pin",ID_COMMENT_CHECKBOX_PINNED)),e.append(create_generic_ele_checkbox(ID_COMMENT_CHECKBOX_PINNED)),e.append(create_generic_ele_label("Highlight",ID_COMMENT_CHECKBOX_HIGHLIGHTED)),e.append(create_generic_ele_checkbox(ID_COMMENT_CHECKBOX_HIGHLIGHTED)),e}function create_ele_jobcomment_editor_controls_container(e,t,_){let n=document.createElement("div");return n.classList.add(CLASS_COMMENT_CONTROLS),n.append(create_ele_jobcomment_editor_save_button(e,t,_)),e!=DEFAULT_COMMENT_ID&&n.append(create_ele_jobcomment_editor_delete_button()),n}function create_ele_jobcomment_editor_save_button(e,t,_){let n=create_generic_ele_submit_button();return n.classList.add(CLASS_SAVE_BTN),n.setAttribute("data-comment_id",e),n.setAttribute(ATTR_LABEL_FORM_TYPE,t),n.addEventListener("click",e=>{_(e.target)}),n}function create_ele_jobcomment_editor_close_button(){let e=create_generic_ele_cancel_button();return e.addEventListener("click",()=>{close_jobcomment_editor()}),e}function create_ele_jobcomment_editor_delete_button(){let e=create_generic_ele_delete_button();return e.addEventListener("click",e=>{delete_job_comment(e.target)}),e}function populate_ele_jobcomment_editor_with_existing(e,t,_){var n=t.querySelector("."+CLASS_COMMENT_CONTENTS).innerHTML.trim();return e.querySelector("#"+ID_COMMENT_TEXTAREA).value=html_tags_to_newlines(n),_&&(null!==(n=string_to_boolean(t.dataset.is_private))&&(e.querySelector("#"+ID_COMMENT_CHECKBOX_PRIVATE).checked=n),null!==(_=string_to_boolean(t.dataset.is_pinned))&&(e.querySelector("#"+ID_COMMENT_CHECKBOX_PINNED).checked=_),null!==(n=string_to_boolean(t.dataset.is_highlighted))&&(e.querySelector("#"+ID_COMMENT_CHECKBOX_HIGHLIGHTED).checked=n)),e}function html_tags_to_newlines(e){return e=(e=(e=(e=(e=(e=(e="<p>"==e.slice(0,3)?e.slice(3):e).replaceAll("\n","")).replaceAll("</p>","")).replaceAll("<p>","\n\n")).replaceAll("<br>","\n")).replaceAll("<br/>","\n")).replaceAll("<br />","\n")}function newlines_to_html_tags(e){let t=e.replaceAll("\n\n","</p><p>");return(t=t.length!==e.length?"<p>"+(t="<p>"===t.slice(-3)?t.slice(0,-3):t)+"</p>":t).replaceAll("\n","<br>")}function update_visibility_comment_content(e,t){let _=e.querySelector(".wrapper");null!=_&&(visibility_element(e.querySelector(".wrapper"),t),t&&_.removeAttribute("open"))}function update_visibility_add_comment_button(e){(e?unhide_all_by_class:hide_all_by_class)(""+CLASS_ADD_BUTTON_COMMENT)}async function save_new_job_comment(e){let t=get_comment_data_from_editor(e);var _=await update_backend_comment(e,t,"POST");status_is_good(_,201)?(t.id=_.id,t[KEY_COMMENT_OWNERSHIP_STRING]="You on "+_.created_on,t.job_id=get_job_id_for_comments(e),update_job_page_comments_after_create(t)):update_job_page_comments_after_failed_create(_,e)}async function save_updated_job_comment(e){let t=get_comment_data_from_editor(e);var _=await update_backend_comment(e,t,"PUT","id="+e.dataset.comment_id);status_is_good(_,204)?(t.id=e.dataset.comment_id,t[KEY_COMMENT_OWNERSHIP_STRING]=get_ownership_string_from_existing_comment(e),t.job_id=get_job_id_for_comments(e),update_job_page_comments_after_update(t)):update_job_page_comments_after_failed_update(_,e)}async function delete_job_comment(e){var t=e.closest("."+CLASS_COMMENT),_=await update_backend_delete_comment(e,t.dataset.comment_id);status_is_good(_,204)?update_job_page_comments_after_delete(t.dataset.comment_id):update_job_page_comments_after_failed_update(_,e)}function get_comment_data_from_editor(e){return e.dataset.form_type==VALUE_FORM_TYPE_CONTENT_ONLY?get_comment_data_from_simplified_editor(e):get_comment_data_from_full_editor()}function get_comment_data_from_full_editor(){let e=get_default_comment_data();var t=document.getElementById(ID_COMMENT_CHECKBOX_PRIVATE),t=(null!=t&&(e.private=t.checked),document.getElementById(ID_COMMENT_CHECKBOX_PINNED)),t=(null!=t&&(e.pinned=t.checked),document.getElementById(ID_COMMENT_CHECKBOX_HIGHLIGHTED));return null!=t&&(e.highlighted=t.checked),e}function get_comment_data_from_simplified_editor(e){let t=get_default_comment_data();t.pinned=!0;e=e.closest("."+CLASS_COMMENT);return null!=e&&(t.private=string_to_boolean(e.dataset.is_private),t.pinned=string_to_boolean(e.dataset.is_pinned),t.highlighted=string_to_boolean(e.dataset.is_highlighted)),t}function get_default_comment_data(){return{contents:document.getElementById(ID_COMMENT_TEXTAREA).value,private:!0,pinned:!1,highlighted:!1}}async function update_backend_comment(e,t,_,n=null){e=get_jobcomments_url(e),_=get_request_options(_,format_comment_data_for_be(t));let o=null!==n?"&"+n:"";return update_backend(""+e+o,_)}async function update_backend_delete_comment(e,t){return update_backend(get_jobcomments_url(e)+"&id="+t,get_request_options("DELETE"))}function get_jobcomments_url(e){return"undefined"!=typeof URL_COMMENTS_WITH_JOB?URL_COMMENTS_WITH_JOB:e.closest("."+CLASS_COMMENT_SECTION).dataset.url_comments}function format_comment_data_for_be(e){return{contents:e.contents,private:e.private,pinned:e.pinned,highlighted:e.highlighted}}function get_job_id_for_comments(e){var t;return"undefined"!=typeof JOB_ID?JOB_ID:null!==(t=e.closest("."+CLASS_JOB_PANEL))?t.dataset.job_id:null!==(t=e.closest("."+CLASS_TODO_HAS_JOB_ID))?t.dataset.job_id:-1}function get_ownership_string_from_existing_comment(e){let t=e.closest("."+CLASS_COMMENT);return t.querySelector("."+CLASS_COMMENT_OWNERSHIP).innerHTML}function update_job_page_comments_after_create(e){close_jobcomment_editor();var t=get_class_to_find_comment(e.id);add_comment_to_section(t,CLASS_COMMENTS_CONTAINER_ALL,e),e.pinned&&add_comment_to_section(t,CLASS_COMMENTS_CONTAINER_PINNED,e),e.highlighted&&add_comment_to_section(t,CLASS_COMMENTS_CONTAINER_HIGHLIGHTED,e),remove_all_jobcomment_warnings(),update_todo_list_row_pinned(e,"create")}function update_job_page_comments_after_update(t){close_jobcomment_editor(),document.querySelectorAll("."+CLASS_PREFIX_FOR_COMMENT_ID+t.id).forEach(e=>{update_comment_ele(t,e)}),update_comment_presence_in_all_filtered_sections(t),update_todo_list_row_pinned(t,"update")}function update_job_page_comments_after_delete(e){document.querySelectorAll("."+CLASS_PREFIX_FOR_COMMENT_ID+e).forEach(e=>{var t=e.closest("."+CLASS_COMMENTS_CONTAINER);e.remove(),handle_section_emptiness(t)}),update_todo_list_row_pinned({id:e},"delete")}function update_job_page_comments_after_failed_create(e,t){t=t.closest("."+CLASS_CREATE_COMMENT_CONTAINER),close_jobcomment_editor(),remove_all_jobcomment_warnings(),e=create_generic_ele_dismissable_error(e);add_error_comment_creation_failed(e,t)}function update_job_page_comments_after_failed_update(e,t){let _=t.closest("."+CLASS_COMMENT),n=(close_jobcomment_editor(),_.querySelector(".contents"));t=create_generic_ele_dismissable_error(e);n.prepend(t)}function add_error_comment_creation_failed(e,t){let _=t.parentElement;var n=_.querySelector("."+CLASS_COMMENTS_CONTAINER),o=get_ele_index(t,_),n=get_ele_index(n,_);let r=t.querySelector("."+CLASS_ADD_BUTTON);n<o&&-1!=n?r.before(e):r.after(e)}function create_ele_comment(e,t){let _=create_ele_comment_base(e);return _.append(create_ele_comment_contents_wrapper(e,t)),add_event_listeners_to_comment_icons(_),_}function create_ele_comment_base(e){let t=document.createElement("article");return t.classList.add(CLASS_COMMENT),t.classList.add(""+CLASS_PREFIX_FOR_COMMENT_ID+e.id),e.highlighted&&t.classList.add(CLASS_HIGHLIGHTED_CSS),t.setAttribute("data-comment_id",e.id),t.setAttribute("data-is_private",e.private),t.setAttribute("data-is_pinned",e.pinned),t.setAttribute("data-is_highlighted",e.highlighted),t}function create_ele_comment_contents_wrapper(e,t){let _=document.createElement(t?"details":"div");return _.classList.add("wrapper"),_.append(create_ele_comment_body(e,t?"summary":"div")),_.append(create_ele_comment_footer(e)),_}function create_ele_comment_body(e,t){let _=document.createElement(t);return _.classList.add("comment-body"),_.append(create_ele_comment_body_contents(e.private,e.contents)),_}function create_ele_comment_body_contents(e,t){let _=document.createElement("span");return _.classList.add(CLASS_COMMENT_MAIN),e&&_.append(create_ele_comment_privacy_status()),_.append(create_ele_comment_contents(t)),_}function create_ele_comment_privacy_status(){let e=document.createElement("div");return e.classList.add(CLASS_PRIVACY_STATUS),e.innerHTML="[PRIVATE]",e}function create_ele_comment_contents(e){let t=document.createElement("span");return t.classList.add(CLASS_COMMENT_CONTENTS),t.innerHTML=newlines_to_html_tags(e),t}function create_ele_comment_footer(e){let t=document.createElement("section");return t.classList.add(CLASS_COMMENT_FOOTER),t.append(create_ele_comment_ownership(e)),t.append(create_ele_comment_controls(e)),t}function create_ele_comment_ownership(e){let t=document.createElement("div"),_=(t.classList.add(CLASS_COMMENT_OWNERSHIP),"Unknown user at unknown time");return KEY_COMMENT_OWNERSHIP_STRING in e?_=e[KEY_COMMENT_OWNERSHIP_STRING]:"created_by"in e&&"created_on"in e&&(_=e.created_by+" on "+e.created_on),t.innerHTML=_,t}function create_ele_comment_controls(e){let t=document.createElement("div");return t.classList.add(CLASS_COMMENT_CONTROLS),t.append(create_ele_comment_pinned_button(e.pinned)),t.append(create_ele_comment_highlight_button()),t.append(create_ele_comment_edit_button()),t}function create_ele_comment_pinned_button(e){e=get_settings_comment_pinned_button(e);let t=create_ele_comment_icon_button(e.display_str,CLASS_PINNED_TOGGLE);return t.classList.add(e.css_class),t}function create_ele_comment_highlight_button(){return create_ele_comment_icon_button("+/- highlight",CLASS_COMMENT_HIGHLIGHTED_TOGGLE)}function create_ele_comment_edit_button(){return create_ele_comment_icon_button("edit",CLASS_COMMENT_EDIT_BTN)}function get_settings_comment_pinned_button(e){return{display_str:e?"unpin":"pin",css_class:e?CLASS_PINNED_BTN_ON:CLASS_PINNED_BTN_OFF,unwanted_css_class:e?CLASS_PINNED_BTN_OFF:CLASS_PINNED_BTN_ON}}function create_ele_comment_icon_button(e,t){let _=document.createElement("button");return _.classList.add(t),_.innerHTML=e,_}function add_event_listeners_to_comment_icons(e){add_event_listener_if_element_exists(e.querySelector("."+CLASS_COMMENT_EDIT_BTN),e=>{open_jobcomment_editor_for_update(e.target)}),add_event_listener_if_element_exists(e.querySelector("."+CLASS_COMMENT_PINNED_TOGGLE),e=>{toggle_status(e.target,"pinned")}),add_event_listener_if_element_exists(e.querySelector("."+CLASS_COMMENT_HIGHLIGHTED_TOGGLE),e=>{toggle_status(e.target,"highlighted")})}function update_comment_presence_in_all_filtered_sections(t){for(let e=0;e<SECTION_NAMES.length;e++)SECTION_NAMES[e]!=CLASS_COMMENTS_CONTAINER_ALL&&update_comment_presence_in_one_filtered_section(t,SECTION_NAMES[e])}function update_comment_presence_in_one_filtered_section(e,t){var _=""+CLASS_PREFIX_FOR_COMMENT_ID+e.id;e[t]?e[t]&&add_comment_to_section(_,t,e):remove_comment_from_section(_,t)}function update_comment_ele(e,t){let _=t.querySelector("."+CLASS_COMMENT_CONTENTS);_.innerHTML=newlines_to_html_tags(e.contents),update_ele_comment_pinned_status(t,e.pinned),update_ele_comment_highlighted_status(t,e.highlighted),update_ele_comment_private_status(t,e.private)}function get_class_to_find_comment(e){return""+CLASS_PREFIX_FOR_COMMENT_ID+e}function remove_all_jobcomment_warnings(){document.querySelectorAll("."+CLASS_ERROR_MESSAGE).forEach(e=>{e.remove()})}function visibility_element(e,t){var _;null!=e&&(_=!e.classList.contains(CSS_HIDE),t&&!_?e.classList.remove(CSS_HIDE):!t&&_&&e.classList.add(CSS_HIDE))}async function toggle_status(e,t){var _=e.closest("."+CLASS_COMMENT),n=get_comment_status_boolean(e,t),e=await update_backend_for_comment_toggle(get_jobcomments_url(e),_.dataset.comment_id,!n,t);status_is_good(e,204)?update_frontend_for_comment_toggle(_,!n,t):alert(get_error_message(e))}function get_comment_status_boolean(e,t){e=e.closest("."+CLASS_COMMENT);if(null!==e){if("pinned"===t)var _=e.dataset.is_pinned;else{if("highlighted"!==t)return;_=e.dataset.is_highlighted}return string_to_boolean(_)}}async function update_backend_for_comment_toggle(e,t,_,n){let o={};return o[n]=_,update_backend(e+"&id="+t,get_request_options("PUT",o))}function update_frontend_for_comment_toggle(e,t,_){var n=get_class_to_find_comment(e.dataset.comment_id);document.querySelectorAll("."+n).forEach(e=>{"pinned"==_?update_ele_comment_pinned_status(e,t):"highlighted"==_&&update_ele_comment_highlighted_status(e,t)}),(t?add_comment_to_section:remove_comment_from_section)(n,_),toggle_todo_list(e,t,_)}function update_ele_comment_pinned_status(e,t){e.setAttribute("data-is_pinned",t),update_comment_pinned_button(e.querySelector("."+CLASS_COMMENT_PINNED_TOGGLE),t)}function update_ele_comment_highlighted_status(e,t){e.setAttribute("data-is_highlighted",t);var _=e.classList.contains(CLASS_HIGHLIGHTED_CSS);t&&!_?e.classList.add(CLASS_HIGHLIGHTED_CSS):!t&&_&&e.classList.remove(CLASS_HIGHLIGHTED_CSS)}function update_ele_comment_private_status(t,e){t.setAttribute("data-is_private",e);let _=t.querySelector("."+CLASS_PRIVACY_STATUS);var n=null!==_;if(n&&!e)_.remove();else if(!n&&e){let e=t.querySelector("."+CLASS_COMMENT_MAIN);e.prepend(create_ele_comment_privacy_status())}}function update_comment_pinned_button(e,t){e.classList.contains(CLASS_PINNED_BTN_ON)!==t&&(t=get_settings_comment_pinned_button(t),e.classList.add(CLASS_PINNED_TOGGLE),e.classList.add(t.css_class),e.classList.remove(t.unwanted_css_class),e.innerHTML=t.display_str)}function add_comment_to_section(t,_,n=null){var o=document.querySelectorAll(`.${CLASS_COMMENTS_CONTAINER}.`+_);if(null!==o&&0!=o.length&&null!==(n=handle_missing_comment_data(n,t))){let e=find_comment_section_ele(o,n.job_id,_);null!==e&&null===e.querySelector("."+t)&&(o=create_ele_comment(n,e.classList.contains(CLASS_STREAMLINED_WANTED)),e.prepend(o),handle_section_emptiness(e,_))}}function remove_comment_from_section(_,n){document.querySelectorAll(`.${CLASS_COMMENTS_CONTAINER}.`+n).forEach(e=>{let t=e.querySelector("."+_);null!==t&&(t.remove(),handle_section_emptiness(e,n))})}function handle_missing_comment_data(e,t){return null!==e?e:null!==(e=document.querySelector("."+t))?get_comment_data_from_comment_ele(e):null}function get_comment_data_from_comment_ele(e){let t={};return t.id=e.dataset.comment_id,t.footer_str=e.querySelector("."+CLASS_COMMENT_OWNERSHIP).innerHTML.trim(),t.contents=html_tags_to_newlines(e.querySelector("."+CLASS_COMMENT_CONTENTS).innerHTML.trim()),t.private="true"==e.dataset.is_private.toLowerCase(),t.pinned="true"==e.dataset.is_pinned.toLowerCase(),t.highlighted="true"==e.dataset.is_highlighted.toLowerCase(),t.job_id=get_job_id_for_comments(e),t}function find_comment_section_ele(t,_,n){if(1===t.length)return t[0];if(("number"==typeof _||"string"==typeof _)&&0<(_="string"==typeof _?parseInt(_):_)){t=""+ID_PREFIX_JOB_PANEL_ON_TODO_LIST+_;let e=document.getElementById(t);if(null!==e)return e.querySelector(`.${CLASS_COMMENTS_CONTAINER}.`+n)}return null}function handle_section_emptiness(e,t=STR_FALLBACK){var _=0===e.querySelectorAll("."+CLASS_COMMENT).length;let n=get_settings_comment_section_emptiness(e,_);n.want_add&&null===n.existing?add_new_comment_emptiness_element(e,t,n.class_indicating_task):n.want_remove&&null!==n.existing&&n.existing.remove()}function get_settings_comment_section_emptiness(e,t){return e.classList.contains(CLASS_EMPTINESS_NOT_PERSISTENT)?{existing:e.parentElement.querySelector("h5"),want_add:!t,want_remove:t,class_indicating_task:CLASS_EMPTINESS_NOT_PERSISTENT}:e.classList.contains(CLASS_EMPTINESS_PERSISTENT)?{existing:e.querySelector("."+CLASS_EMPTINESS_MESSAGE),want_add:t,want_remove:!t,class_indicating_task:CLASS_EMPTINESS_PERSISTENT}:null}function add_new_comment_emptiness_element(e,t,_){var n,o;t===STR_FALLBACK&&null!==(n=find_comment_section_name_in_classlist(e))&&(t=n),_===CLASS_EMPTINESS_NOT_PERSISTENT?(o=create_ele_heading_for_conditional_comment_section(t),e.before(o)):_===CLASS_EMPTINESS_PERSISTENT&&(o=create_ele_emptiness_explanation_for_comment_section(t),e.prepend(o))}function create_ele_heading_for_conditional_comment_section(e){let t=document.createElement("h5"),_=document.createElement("span");return _.classList.add(CSS_HIDE),e===STR_FALLBACK?_.innerHTML="Comments":_.innerHTML=e,t.append(_),t}function create_ele_emptiness_explanation_for_comment_section(e){let t=document.createElement("p");return t.classList.add(CLASS_EMPTINESS_MESSAGE),e==CLASS_COMMENTS_CONTAINER_HIGHLIGHTED||e==CLASS_COMMENTS_CONTAINER_PINNED?t.innerHTML=`No comments have been ${e}.`:t.innerHTML="No comments yet.",t}function find_comment_section_name_in_classlist(t){for(let e=0;e<SECTION_NAMES.length;e++)if(t.classList.contains(SECTION_NAMES[e]))return SECTION_NAMES[e];return null}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("."+CLASS_ADD_BUTTON_COMMENT).forEach(e=>{e.addEventListener("click",e=>{open_jobcomment_editor_for_create(e.target)})}),document.querySelectorAll("."+CLASS_COMMENT_EDIT_BTN).forEach(e=>{e.addEventListener("click",e=>{open_jobcomment_editor_for_update(e.target)})}),document.querySelectorAll("."+CLASS_COMMENT_PINNED_TOGGLE).forEach(e=>{e.addEventListener("click",e=>{toggle_status(e.target,"pinned")})}),document.querySelectorAll("."+CLASS_COMMENT_HIGHLIGHTED_TOGGLE).forEach(e=>{e.addEventListener("click",e=>{toggle_status(e.target,"highlighted")})})});const CLASS_REMOVE_JOB_BTN="todo-list-remove",CLASS_ADD_JOB_BTN="todo-list-add",ID_PREFIX_JOB_PANEL="todo_panel_job_",CLASS_TODO_ERROR_MSG="todo-error-message",CLASS_JOB_PANEL_DETAILS="job-details";async function remove_from_todo_list(e){var t=get_request_options("DELETE",{job_id:e.dataset.job_id}),t=await update_backend(""+URL_TODO_MANAGEMENT,t);clear_todo_error_from_job_panels(),status_is_good(t,204)?update_frontend_after_removal(e,e.dataset.job_id):display_todo_error_on_job_panel(t,e.dataset.job_id)||alert(get_error_message(t))}async function add_to_todo_list(e){var t=get_request_options("PUT",{job_id:e.dataset.job_id}),t=await update_backend(""+URL_TODO_MANAGEMENT,t);status_is_good(t,204)?update_frontend_after_add(e):alert(get_error_message(t))}function update_frontend_after_removal(e,t){e.classList.contains(CLASS_REMOVE_JOB_BTN)&&remove_job_panel_from_todo_list(t)}function update_frontend_after_add(e){e.classList.contains(CLASS_ADD_JOB_BTN)&&replace_todo_add_btn_with_on(e)}function display_todo_error_on_job_panel(e,t){return!!(active_ele=document.querySelector("#"+ID_PREFIX_JOB_PANEL+t))&&(msg_ele=create_generic_ele_dismissable_error(e),active_ele.prepend(msg_ele),!0)}function clear_todo_error_from_job_panels(){document.querySelectorAll("."+CLASS_ERROR_MESSAGE).forEach(e=>{e.remove()})}function remove_job_panel_from_todo_list(e){null!=(ele_to_remove=document.querySelector("#"+ID_PREFIX_JOB_PANEL+e))&&ele_to_remove.remove()}function replace_todo_add_btn_with_on(e){let t=document.createElement("span");t.classList.add(CLASS_ADD_JOB_BTN),t.innerHTML="on",e.before(t),e.remove()}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("."+CLASS_REMOVE_JOB_BTN).forEach(e=>{e.addEventListener("click",()=>{remove_from_todo_list(e)})}),document.querySelectorAll("."+CLASS_ADD_JOB_BTN).forEach(e=>{e.addEventListener("click",()=>{add_to_todo_list(e)})})});const ID_DOCUMENT_REPLACEMENT_BTN="replace_document_btn",ID_DOCUMENT_REVERT_BTN="revert_document_btn";async function replace_issued_document(){var e=get_request_options("POST"),e=await update_backend(`${URL_DOC_MAIN}?doc_id=${DOC_ID}&task=replace`,e);console.log(e),status_is_good(e,201)?window.location.href=e[KEY_LOCATION]:display_document_response_message(e)}async function revert_issued_document(){var e=get_request_options("POST"),e=await update_backend(`${URL_DOC_MAIN}?doc_id=${DOC_ID}&task=revert`,e);console.log(e),status_is_good(e,200)?window.location.href=e[KEY_LOCATION]:display_document_response_message(e)}async function update_address(e){let t=e.closest(".form-row").querySelector(".display-address");var _;0!=e.selectedIndex?status_is_good(e=await get_address_from_server(e.value))?(_=format_address(e),t.innerHTML=_):t.innerHTML=get_error_message(e):t.innerHTML=""}async function get_address_from_server(e){return get_json_with_status(await fetch(URL_SITE_ADDRESS+"?type=site_address&id="+e).catch(e=>{console.log("Error: ",e)}))}function format_address(e){var t=e.address.replaceAll(",","<br />"),t=add_str_and_br_if_not_blank(t+="<br />",e.region);return t=add_str_and_br_if_not_blank(t,e.postcode),add_str_and_br_if_not_blank(t,e.country)}function add_str_and_br_if_not_blank(e,t){return""!=t?e+(t+"<br />"):e}document.addEventListener("DOMContentLoaded",()=>{null!=(replace_btn=document.querySelector("#"+ID_DOCUMENT_REPLACEMENT_BTN))&&replace_btn.addEventListener("click",()=>{replace_issued_document()}),null!=(revert_btn=document.querySelector("#"+ID_DOCUMENT_REVERT_BTN))&&revert_btn.addEventListener("click",()=>{revert_issued_document()})}),CLASS_ADDRESS_DROPDOWN="address-dropdown",document.addEventListener("DOMContentLoaded",e=>{document.querySelectorAll("."+CLASS_ADDRESS_DROPDOWN).forEach(e=>{let t=e.querySelector("select");update_address(t),t.addEventListener("change",e=>{update_address(e.target)})})});const ID_DELETE_JOB_BTN="delete_job_btn";async function delete_job(){var e=get_request_options("DELETE"),e=await update_backend(URL_DELETE_JOB,e);204===get_status_from_json(e)?window.location.href="/":status_is_good(e)||display_delete_failed_message(e)}function display_delete_failed_message(t){var _=get_error_message(t);let n=document.querySelector("."+CLASS_ERROR_MESSAGE);if(null==n||n.getElementsByTagName("DIV")[0].innerHTML!=_){null!=n&&n.remove();let e=document.getElementById(ID_DELETE_JOB_BTN);_=create_generic_ele_dismissable_error(t);e.after(_)}}function openPinnedCommentsModal(e){e=e.target.closest("[data-target_id]").dataset.target_id;if(void 0===e)window.alert("Can't open pinned comments");else{const t=document.getElementById(e),_=(open_modal(t),t.querySelector(`.${CSS_MODAL}_`+CSS_CLOSE_BUTTON));void 0!==_&&_.addEventListener("click",()=>{t.classList.add(CSS_HIDE),modalEle.close()})}}function toggle_todo_list(e,t,_){var n="pinned"!==_||t?"update":"delete";const o={...get_comment_data_from_comment_ele(e),[_]:t};o.contents=newlines_to_spaces(o.contents),update_todo_list_row_pinned(o,n)}function update_todo_list_row_pinned(e,t){var _=find_pinned_button_which_opened_modal();null!==_&&(_.dataset.comment_id===e.id||"create"===t?update_ele_todo_pinned_comment(_,e,_.dataset.jobName):"delete"===t&&update_ele_todo_pinned_comment(_,null!==(t=get_data_for_next_pinned_comment(e.id))?t:{id:DEFAULT_COMMENT_ID,contents:null,pinned:!0,highlighted:!1,private:!0},_.dataset.jobName))}function get_data_for_next_pinned_comment(t){const e=find_open_modal();if(is_pinned_comments_modal(e)){const n=e.querySelectorAll("."+CLASS_COMMENT);if(null!==n)for(let e=0;e<n.length;e++){var _=""+CLASS_PREFIX_FOR_COMMENT_ID+t;if(!n[e].classList.contains(_))return get_comment_data_from_comment_ele(n[e])}}return null}function find_pinned_button_which_opened_modal(){var e=find_open_modal();return is_pinned_comments_modal(e)?find_pinned_button_with_data_target_id(e.parentNode.id):null}function is_pinned_comments_modal(e){return null!==e&&e.classList.contains("pinnedCommentsModal")}function find_open_modal(){var t=document.querySelectorAll("."+CSS_MODAL);let _=null;for(let e=0;e<t.length;e++)if(t[e].open){_=t[e];break}return _}function find_pinned_button_with_data_target_id(t){var _=document.querySelectorAll(".pinnedModalOpener");let n=null;for(let e=0;e<_.length;e++)if(_[e].dataset.target_id===t){n=_[e];break}return n}function update_ele_todo_pinned_comment(e,t,_){e.setAttribute("data-comment_id",t.id);var n="todoJob_pinnedComment-empty",o="todoJob_pinnedComment-highlighted";null===t.contents||""===t.contents||void 0===t.contents?(e.classList.contains(n)||e.classList.add(n),e.classList.remove(o),e.replaceChildren(create_ele_todo_pinned_comment_contents("Click to add pinned comments"))):(t.highlighted?e.classList.contains(o)||e.classList.add(o):e.classList.remove(o),e.classList.remove(n),e.replaceChildren(create_ele_todo_pinned_comment_srButtonLabel(_),create_ele_todo_pinned_comment_privacyIcon(t.private),create_ele_todo_pinned_comment_contents(newlines_to_spaces(t.contents))))}function create_ele_todo_pinned_comment_srButtonLabel(e){const t=document.createElement("span");return t.className="sr-only",t.innerText="pinned comments for "+e,t}function create_ele_todo_pinned_comment_privacyIcon(e){const t=document.createElement("span");return t.classList.add("todoJob_pinnedPrivacyStatus"),t.classList.add("todoJob_pinnedPrivacyStatus-"+(e?"private":"public")),t.innerText=`[${e?"PRIVATE":"public"}]`,t}function create_ele_todo_pinned_comment_contents(e){const t=document.createElement("p");return t.className="todoJob_pinnedContents",t.innerText=e,t}function newlines_to_spaces(e){return e.replaceAll("\n"," ")}function closeOnClickOutside(e,t,_){e.composedPath().includes(t)||_()}document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById(ID_DELETE_JOB_BTN);null!=e&&e.addEventListener("click",()=>{delete_job()})}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".pinnedModalOpener").forEach(e=>{e.addEventListener("click",e=>openPinnedCommentsModal(e))})}),document.addEventListener("DOMContentLoaded",()=>{const t="statusEle",_="statusEle_message",i="statusEle_message-hidden",s="statusEle_icon";function n(e){return!e.classList.contains(i)}function o(e){const a=m(e),c=u(a);n(c)||window.setTimeout(()=>{var e,t,_,n;function o(){l(_),document.removeEventListener("click",r)}function r(e){closeOnClickOutside(e,n,o)}d(),e=c,t=a,e.textContent=function(e){e=e.querySelector("."+s);return void 0===e.dataset.toggletip_content?"No details are available":e.dataset.toggletip_content}(t),e.classList.remove(i),_=c,n=a,document.addEventListener("click",r)},100)}function r(e){e=u(m(e));n(e)&&l(e)}function d(){document.querySelectorAll("."+_).forEach(e=>{n(e)&&l(e)})}function l(e){e.textContent="",e.classList.add(i)}function m(e){return e.target.classList.contains(t)?e.target:e.target.closest("."+t)}function u(e){if(null!=e)return e.querySelector("."+_);window.alert("Can't display status details, try the job page instead.")}d(),document.querySelectorAll("."+s).forEach(e=>{e.addEventListener("click",e=>o(e)),e.addEventListener("keydown",e=>{27===(e.keyCode||e.which)&&r(e),13===(e.keyCode||e.which)&&o(e)}),e.addEventListener("blur",e=>r(e))})});const CSS_MODAL="modal",CSS_CLOSE_BUTTON="closeButton",CSS_MODAL_WRAPPER="modalWrapper",CSS_MODAL_HEADING="modal_heading",CSS_MODAL_CONTENTS="modal_contents";function create_generic_modal(e){const t=create_generic_modal_wrapper(),_=create_generic_modal_dialog(),n=create_generic_ele_cancel_button();return n.classList.add(CSS_MODAL+"_"+CSS_CLOSE_BUTTON),n.addEventListener("click",()=>{t.classList.contains(CSS_HIDE)||t.classList.add(CSS_HIDE),_.close()}),_.append(n),_.append(e),t.append(_),t}function create_generic_modal_dialog(){let e=document.createElement("dialog");return e.classList.add(CSS_MODAL),e}function create_generic_modal_wrapper(){let e=document.createElement("div");return e.classList.add(CSS_MODAL_WRAPPER),e.classList.add(CSS_HIDE),e}function open_modal(e){e.classList.remove(CSS_HIDE);const t=e.querySelector("."+CSS_MODAL);t.show()}