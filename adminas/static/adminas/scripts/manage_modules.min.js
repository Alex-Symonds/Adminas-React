const CLASS_ADD_SLOT_BUTTON="add-slot",CLASS_EDITOR_SLOT_FILLER_QUANTITY="editor-slot-filler-quantity",CLASS_EXCESS_MODULES="excess-modules",CLASS_INDICATOR_IS_FULL="filled",CLASS_OPTION_EXISTING_ITEM="bucket-item",CLASS_MODULE_SLOT_GENERAL="module-slot",CLASS_MODULE_SLOT_IN_EDIT_MODE="editing",CLASS_MODULE_SLOT_IS_EMPTY="empty",CLASS_MODULE_SLOT_FILLER_POPOUT_MENU="module-bucket-container",CLASS_NEW_ITEMS_CONTAINER="new-slot-filler-inputs",CLASS_PARENT_ITEM_CONTAINER="modular-item-container",CLASS_PRODUCT_DESC="product_desc",CLASS_SLOT_CONTAINER="modular-slot-container",ID_CREATE_JOBITEM_SUBMIT_BUTTON="id_submit_new",ID_EDIT_FORM_SUBMIT_BUTTON="id_submit_qty_edit";function get_slot_and_parent_ids(e){return null===(e=e.classList.contains(CLASS_SLOT_CONTAINER)?e:e.closest("."+CLASS_SLOT_CONTAINER))?null:{slot:e.dataset.slot,parent:e.dataset.parent}}function required_fields_are_present(t,_){for(let e=0;e<_.length;e++)if(void 0===t[_[e]])return!1;return!0}function add_ele_module_slot_empty(e){let t=e.target.closest("."+CLASS_SLOT_CONTAINER),_=t.querySelector(".contents");e=create_ele_module_slot_empty();_.append(e)}function create_ele_module_slot_empty(){let e=document.createElement("div"),t=(e.classList.add(CLASS_MODULE_SLOT_GENERAL),e.classList.add(CLASS_MODULE_SLOT_IS_EMPTY),document.createElement("i"));return t.innerHTML="Click to fill",e.append(t),e.addEventListener("click",e=>{open_module_slot_filler_menu(e)}),e}async function open_module_slot_filler_menu(e){let t=find_anchor_ele_module_slot_filler_menu(e.target);e=get_slot_and_parent_ids(e.target),e=await create_ele_module_slot_filler_menu(e.slot,e.parent);t.after(e),remove_ele_all_errors()}function close_module_slot_filler_menu(){document.querySelector("."+CLASS_MODULE_SLOT_FILLER_POPOUT_MENU).remove()}function find_anchor_ele_module_slot_filler_menu(e){return e.classList.contains(CLASS_MODULE_SLOT_IS_EMPTY)?e:e.closest("."+CLASS_MODULE_SLOT_GENERAL+"."+CLASS_MODULE_SLOT_IS_EMPTY)}async function create_ele_module_slot_filler_menu(e,t){let _=create_ele_module_slot_filler_menu_base();_.append(create_ele_module_slot_filler_menu_cancel_btn());e=await get_list_for_module_slot(e,t,"jobitems");return status_is_good(e,200)?required_fields_are_present(e,[t="parent_quantity","opt_list"])?(_.append(create_ele_module_slot_filler_menu_title(e[t])),_.append(create_ele_module_slot_filler_menu_existing_items(e)),_.append(create_ele_module_slot_filler_menu_new_jobitem_btn())):_.append(create_ele_module_slot_error("Failed to load.")):_.append(create_ele_module_slot_error(e,"Failed to load.")),_}function create_ele_module_slot_filler_menu_base(){let e=document.createElement("div");return e.classList.add(CLASS_MODULE_SLOT_FILLER_POPOUT_MENU),e.classList.add(CSS_GENERIC_PANEL),e.classList.add(CSS_GENERIC_FORM_LIKE),e.classList.add("popout"),e}function create_ele_module_slot_filler_menu_title(e){let t=document.createElement("h4");return t.classList.add(CSS_GENERIC_PANEL_HEADING),t.innerHTML=`Assign ${e} x ...`,t}function create_ele_module_slot_filler_menu_cancel_btn(){let e=create_generic_ele_cancel_button();return e.addEventListener("click",()=>{close_module_slot_filler_menu()}),e}function create_ele_module_slot_filler_menu_existing_items(e){var t=e.opt_list;if(0===t.length){let e=document.createElement("p");return e.innerHTML="There are no unassigned items on this job which are suitable for this slot.",e}let _=document.createElement("div");_.classList.add("bucket-options-container");for(var l=0;l<t.length;l++){var o=create_ele_module_slot_filler_menu_existing_option(t[l],parseInt(e.parent_quantity));_.append(o)}return _}async function get_list_for_module_slot(e,t,_){_=URL_GENERAL_API+`?type=select_options_list&name=slot_options_${_}&parent=${t}&slot=`+e;return query_backend(_)}function create_ele_module_slot_filler_menu_existing_option(e,t){var _=document.createElement("div"),l=(_.classList.add(CLASS_OPTION_EXISTING_ITEM),"name"),o="quantity_available",n="quantity_total";return required_fields_are_present(e,["id",l,o,n])?(_.setAttribute("data-child",e.id),t>parseInt(e[o])?_.classList.add("jobitem_usedup"):(_.classList.add("jobitem"),_.addEventListener("click",e=>{assign_existing_jobitem_product_to_slot(e)})),_.append(create_ele_module_slot_filler_menu_existing_option_jobitem_name(e[l])),_.append(create_ele_module_slot_filler_menu_existing_option_quantity_available(e[o],e[n]))):_.innerHTML="Error: failed to load",_}function create_ele_module_slot_filler_menu_existing_option_jobitem_name(e){let t=document.createElement("span");return t.classList.add(CLASS_PRODUCT_DESC),t.innerHTML=e,t}function create_ele_module_slot_filler_menu_existing_option_quantity_available(e,t){let _=document.createElement("div");return _.classList.add("availability"),_.innerHTML=e+`/${t} available`,_}function create_ele_module_slot_filler_menu_new_jobitem_btn(){let e=document.createElement("button");return e.innerHTML="new item to job",e.classList.add("add-button"),e.classList.add("module"),e.addEventListener("click",e=>{open_module_slot_new_jobitem_form(e)}),e}async function open_module_slot_new_jobitem_form(e){let t=e.target.closest("."+CLASS_MODULE_SLOT_FILLER_POPOUT_MENU),_=t.previousSibling;e=get_slot_and_parent_ids(e.target),e=await create_ele_module_slot_new_jobitem_form(e.slot,e.parent);_.after(e),_.remove(),t.remove()}function close_module_slot_new_jobitem_form(e){let t=e.closest("."+CLASS_MODULE_SLOT_GENERAL);e=create_ele_module_slot_empty();t.after(e),t.remove()}async function create_ele_module_slot_new_jobitem_form(e,t){let _=create_ele_module_slot_new_jobitem_form_main();_.append(create_ele_module_slot_new_jobitem_form_heading()),_.append(create_ele_module_slot_new_jobitem_form_cancel_btn());e=await get_list_for_module_slot(e,t,"products");if(status_is_good(e,200)&&void 0!==e.opt_list)return _.append(create_ele_module_slot_product_options_dropdown(e.opt_list)),_.append(create_ele_module_slot_new_jobitem_form_quantity_and_submit()),_;_.append(create_ele_module_slot_error(e,"Failed to load dropdown."))}function create_ele_module_slot_new_jobitem_form_main(){let e=document.createElement("div");return e.classList.add(CLASS_MODULE_SLOT_GENERAL),e.classList.add(CLASS_NEW_ITEMS_CONTAINER),e}function create_ele_module_slot_new_jobitem_form_heading(){let e=document.createElement("H5");return e.innerHTML="Fill slot with new item",e}function create_ele_module_slot_product_options_dropdown(t){let _=document.createElement("select");_.name="product";for(let e=0;e<t.length;e++){var l=t[e],o=document.createElement("option");o.value=l.id,o.innerHTML=l.name+" @ "+l.price_f,_.append(o)}return _}function create_ele_module_slot_new_jobitem_form_quantity_and_submit(){let e=document.createElement("div"),t=(e.classList.add("combo-input-and-button"),create_generic_ele_jobitem_quantity_input());return t.value=1,e.append(t),e.append(create_ele_module_slot_new_jobitem_form_submit_btn()),e}function create_ele_module_slot_new_jobitem_form_submit_btn(){let e=create_generic_ele_submit_button();return e.id=ID_CREATE_JOBITEM_SUBMIT_BUTTON,e.addEventListener("click",e=>{assign_new_jobitem_product_to_slot(e)}),e}function create_ele_module_slot_new_jobitem_form_cancel_btn(){let e=create_generic_ele_cancel_button();return e.addEventListener("click",e=>{close_module_slot_new_jobitem_form(e.target)}),e}async function assign_new_jobitem_product_to_slot(e){var t=get_slot_and_parent_ids(e.target);let _=e.target.closest("."+CLASS_NEW_ITEMS_CONTAINER);var l,o=_.querySelector('input[name="qty"]').value,n=_.lastChild,e=await update_server_create_jobitem(e,_,t,o,n);null!==e&&null!==(e=await get_jobitem_data(e,n,"Failed to fill slot. Try refreshing the page."))&&("undefined"===e[l="product_id"]?add_ele_module_slot_error(n,failed_task_text):null!==(e=await update_server_create_jobmodule(e[l],t,o,n))&&(add_ele_filled_module_slot(e,o,o+" x "+get_product_desc_from_select_desc(_.querySelector("select")),_),_.remove()))}async function get_jobitem_data(e,t,_){e=URL_ITEMS+"?ji_id="+e,e=await query_backend(e);return status_is_good(e,200)?e:(add_ele_module_slot_error(t,e,_),null)}async function assign_existing_jobitem_product_to_slot(e){var t=get_slot_and_parent_ids(e.target);let _=find_existing_jobitem_ele(e.target);let l=e.target.closest("."+CLASS_MODULE_SLOT_FILLER_POPOUT_MENU),o=l.previousSibling;t=await update_server_create_jobmodule(_.dataset.child,t,1,o);null!==t&&(add_ele_filled_module_slot(t,1,e.target.closest("."+CLASS_PARENT_ITEM_CONTAINER).dataset.quantity+" x "+_.querySelector("."+CLASS_PRODUCT_DESC).innerHTML,o),o.remove()),l.remove()}function find_existing_jobitem_ele(e){return e.classList.contains(CLASS_OPTION_EXISTING_ITEM)?e:e.closest("."+CLASS_OPTION_EXISTING_ITEM)}function add_ele_filled_module_slot(e,t,_,l){void 0===e?add_ele_module_slot_error(l,"Display error: try refreshing the page."):(_=create_ele_module_slot_filled(_,t,e),l.after(_),update_module_slot_status(_))}async function update_server_create_jobitem(e,t,_,l,o){l*=e.target.closest("."+CLASS_PARENT_ITEM_CONTAINER).dataset.quantity,e=t.querySelector("select").value,t=await update_server_post_jobitem(_.parent,l,e);return status_is_good(t,201)?void 0===(_=t.id)?(add_ele_module_slot_error(o,"Error: item not assigned to slot."),null):_:(add_ele_module_slot_error(o,t,"Failed to add new item to job."),null)}async function update_server_create_jobmodule(e,t,_,l){e=await update_server_post_jobmodule(e,t.parent,t.slot,_);return status_is_good(e)?void 0===(t=e.id)?(add_ele_module_slot_error(l,"Display error: try refreshing the page."),null):t:(add_ele_module_slot_error(l,e,"Failed to assign item to slot."),null)}async function update_server_post_jobitem(e,t,_){t=getRequestOptions("POST",{quantity:t,product:_,parent:e});return update_backend(URL_ITEMS,t)}async function update_server_post_jobmodule(e,t,_,l=1){t=getRequestOptions("POST",{parent:t,child:e,slot:_,quantity:l});return update_backend(URL_ASSIGNMENTS,t)}function get_product_desc_from_select_desc(e){let t=e.options[e.selectedIndex].text;return t.match(/^.+(?=( @ ))/)[0]}function create_ele_module_slot_filled(e,t,_){let l=document.createElement("div");return l.classList.add(CLASS_MODULE_SLOT_GENERAL),l.classList.add("jobitem"),l.append(create_ele_slot_filler_edit_btn(_)),l.append(create_ele_slot_filler_desc_span(e,t)),l}function create_ele_slot_filler_edit_btn(e){let t=create_generic_ele_edit_button();return t.setAttribute("data-jobmod",e),t.addEventListener("click",e=>{open_editor_module_slot_filler(e)}),t}function create_ele_slot_filler_desc_span(e,t){var _=QTY_RE;let l=document.createElement("span");return l.classList.add("child-desc"),l.innerHTML=e.replace(_,t),l}function open_editor_module_slot_filler(e){let t=e.target.closest("."+CLASS_MODULE_SLOT_GENERAL),_=t.querySelector(".child-desc");e=e.target.dataset.jobmod;let l=_.innerHTML;t.prepend(create_ele_editor_module_slot_filler(e,l)),_.innerHTML=l.replace(QTY_RE,""),t.classList.add(CLASS_MODULE_SLOT_IN_EDIT_MODE),_.classList.add(CSS_HIDE),hide_all_by_class(CSS_EDIT_ICON),hide_all_by_class("remove-from-slot-btn")}function close_editor_module_slot_filler(e,t){let _=e.closest("."+CLASS_MODULE_SLOT_GENERAL);let l=_.querySelector("input").dataset.prev_qty,o=(void 0!==t&&(l=t),_.querySelector("."+CLASS_EDITOR_SLOT_FILLER_QUANTITY)),n=(o&&o.remove(),_.querySelector(".child-desc"));n.innerHTML=l+n.innerHTML,n.classList.contains(CSS_HIDE)&&n.classList.remove(CSS_HIDE),_.classList.contains(CLASS_MODULE_SLOT_IN_EDIT_MODE)&&_.classList.remove(CLASS_MODULE_SLOT_IN_EDIT_MODE),unhide_all_by_class(CSS_EDIT_ICON),remove_ele_all_errors()}function create_ele_editor_module_slot_filler(e,t){let _=document.createElement("div");return _.classList.add(CLASS_EDITOR_SLOT_FILLER_QUANTITY),_.append(create_ele_module_slot_filler_editor_cancel_btn()),_.append(create_ele_module_slot_filler_editor_description(t)),_.append(create_ele_module_slot_filler_editor_delete_btn(e)),_.append(create_ele_module_slot_filler_editor_quantity_and_submit(e,t)),_}function create_ele_module_slot_filler_editor_description(e){let t=document.createElement("span");return t.classList.add("desc"),t.innerHTML=get_description_without_quantity_x(e),t}function get_description_without_quantity_x(e){return e.trim().replace(/^.+( x )/,"")}function create_ele_module_slot_filler_editor_quantity_and_submit(e,t){let _=document.createElement("span");return _.classList.add("combo-input-and-button"),_.append(create_ele_module_slot_filler_editor_quantity_field(e,t)),_.append(create_ele_module_slot_filler_editor_submit_btn()),_}function create_ele_module_slot_filler_editor_quantity_field(e,t){let _=create_generic_ele_jobitem_quantity_input();return _.value=t.match(QTY_RE),_.setAttribute("data-id",e),_.setAttribute("data-prev_qty",t.match(QTY_RE)),_.addEventListener("keydown",e=>{"Enter"===e.key&&update_module_slot_quantity(e.target)}),_}function create_ele_module_slot_filler_editor_submit_btn(){let e=create_generic_ele_submit_button();return e.id=ID_EDIT_FORM_SUBMIT_BUTTON,e.addEventListener("click",e=>{update_module_slot_quantity(e.target.previousSibling)}),e}function create_ele_module_slot_filler_editor_delete_btn(e){let t=document.createElement("button"),_=(t.classList.add("delete-panel"),document.createElement("span"));return _.innerHTML="unassign",t.append(_),t.setAttribute("data-jobmod",e),t.addEventListener("click",e=>{remove_jobitem_from_slot(e)}),t}function create_ele_module_slot_filler_editor_cancel_btn(){let e=create_generic_ele_cancel_button();return e.classList.add("close-edit-mode"),e.addEventListener("click",e=>{close_editor_module_slot_filler(e.target)}),e}async function update_module_slot_quantity(e){var t=await update_server_put_module_slot_quantity(e);status_is_good(t,204)?update_page_module_slot_quantity(e,e.dataset.id):add_ele_module_slot_error(e.parentElement,data)}async function update_server_put_module_slot_quantity(e){e=getRequestOptions("PUT",{qty:e.value,prev_qty:e.dataset.prev_qty,id:e.dataset.id});return update_backend(URL_ASSIGNMENTS,e)}function update_page_module_slot_quantity(e,t){""===e.value||parseFloat(e.value)<=0?close_editor_module_slot_filler(e):(update_module_slot_status(e,t),close_editor_module_slot_filler(e,e.value))}async function remove_jobitem_from_slot(e){var t=await update_server_delete_jobmodule(e);status_is_good(t)?update_page_remove_jobitem_from_slot(e):add_ele_module_slot_error(document.getElementById(ID_EDIT_FORM_SUBMIT_BUTTON),t,"Failed to empty slot.")}async function update_server_delete_jobmodule(e){var t=getRequestOptions("DELETE");return update_backend(URL_ASSIGNMENTS+"?id="+e.target.dataset.jobmod,t)}function update_page_remove_jobitem_from_slot(e){var t=create_ele_module_slot_empty();let _=e.target.closest("."+CLASS_MODULE_SLOT_GENERAL);_.after(t),_.remove(),update_module_slot_status(t),close_editor_module_slot_filler(e.target)}async function update_module_slot_status(e){var t,_,l,o,n=e.closest("."+CLASS_SLOT_CONTAINER).querySelector("."+CLASS_ADD_SLOT_BUTTON),r="Refresh page to update slot status.",s=await get_module_slot_status(e,n,r);null!==s&&(required_fields_are_present(s,[t="required_str",_="optional_str",l="slot_num_excess",o="jobitem_has_excess"])?update_page_module_slot_status(e,s[t],s[_],s[l],s[o]):add_ele_module_slot_error(n,r))}async function get_module_slot_status(e,t,_){e=get_slot_and_parent_ids(e),e=`${URL_ASSIGNMENTS}?parent_id=${e.parent}&slot_id=`+e.slot,e=await query_backend(e);return status_is_good(e,200)?e:(add_ele_module_slot_error(t,e,_),null)}function update_page_module_slot_status(e,t,_,l,o){var n=e.closest("."+CLASS_SLOT_CONTAINER),t=(update_ele_slot_status_indicator(n,"required",t),update_ele_slot_status_indicator(n,"optional",_),update_ele_slot_status_indicator_excess(n,"excess",l),e.closest(".subsection")),_=(update_conditional_css_class(t,CLASS_EXCESS_MODULES,0<parseInt(l)),e.closest("."+CLASS_PARENT_ITEM_CONTAINER));update_conditional_css_class(_,CLASS_EXCESS_MODULES,o)}function update_conditional_css_class(e,t,_){var l=e.classList.contains(t);_&&!l?e.classList.add(t):!_&&l&&e.classList.remove(t)}function update_ele_slot_status_indicator(e,t,_){let l=e.querySelector("."+t),o=l.querySelector(".body");o.innerHTML=_,text_is_full=slot_status_display_text_shows_full_slot(_),update_conditional_css_class(l,CLASS_INDICATOR_IS_FULL,text_is_full)}function slot_status_display_text_shows_full_slot(e){e=e.split("/");return e[0]===e[1]}function update_ele_slot_status_indicator_excess(t,_,l){var e=null!==t.querySelector("."+_),o=0<parseInt(l);if(!o&&e)t.querySelector("."+_).remove();else if(o&&!e){var n=create_ele_excess_slot_status_indicator(l);let e=t.querySelector(".slot-info");e.append(n)}else if(o&&e){let e=t.querySelector("."+_).querySelector(".body");e.innerHTML=l}}function create_ele_excess_slot_status_indicator(e){let t=document.createElement("div"),_=(t.classList.add("excess"),document.createElement("span")),l=(_.classList.add("head"),_.innerHTML="excess",t.append(_),document.createElement("span"));return l.classList.add("body"),l.innerHTML=e,t.append(l),t}function add_ele_module_slot_error(e,t,_=null){t=create_ele_module_slot_error(t,_);e.after(t)}function create_ele_module_slot_error(e,t=null){let _=document.createElement("div");return _.classList.add(CLASS_ERROR_MESSAGE),_.innerHTML=get_error_message(e,t),_}function is_error_ele(e){return CLASS_ERROR_MESSAGE in e.classList}function remove_ele_all_errors(){document.querySelectorAll("."+CLASS_ERROR_MESSAGE).forEach(e=>{e.remove()})}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("."+CLASS_MODULE_SLOT_GENERAL+"."+CLASS_MODULE_SLOT_IS_EMPTY).forEach(e=>{e.addEventListener("click",e=>{open_module_slot_filler_menu(e)})}),document.querySelectorAll("."+CLASS_ADD_SLOT_BUTTON).forEach(e=>{e.addEventListener("click",e=>{add_ele_module_slot_empty(e)})}),document.querySelectorAll(".edit-slot-filler-btn").forEach(e=>{e.addEventListener("click",e=>{open_editor_module_slot_filler(e)})})});