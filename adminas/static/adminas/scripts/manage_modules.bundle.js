(()=>{"use strict";const e=/\d+(?=( x ))/g,t="temp-warning-msg",n="panel",a="panel-header",r="form-like",i="edit-icon",l="hide",s="http_code",o="location",c=new Set([200,201,204]),d=-1;function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n={method:e,headers:(a=function(e){let t=null;if(document.cookie&&""!==document.cookie){const n=document.cookie.split(";");for(let a=0;a<n.length;a++){const r=n[a].trim();if(r.substring(0,10)===e+"="){t=decodeURIComponent(r.substring(10));break}}}return t}("csrftoken"),r=new Headers,r.append("X-CSRFToken",a),r),credentials:"include"};var a,r;return null!=t&&(n.body=JSON.stringify(t)),n}async function p(e,t){let n=await fetch(e,t).catch((e=>{console.log("Error: ",e)}));return await f(n)}async function m(e){let t=await fetch(e).catch((e=>{console.log("Error: ",e)}));return await f(t)}async function f(e){const t=e.headers.get("content-type");if(t&&-1!==t.indexOf("application/json"))var n=await e.json();else n={};return n[s]=e.status,n[o]=e.headers.get("Location"),n}function L(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const n=function(e){return"object"!=typeof e?d:s in e?"string"==typeof e[s]?parseInt(e[s]):e[s]:d}(e);return n!==d&&(null===t?c.has(n):n===t)}function v(e){document.querySelectorAll("."+e).forEach((e=>{e.classList.add(l)}))}function y(){let e=document.createElement("button");e.classList.add("close");let t=document.createElement("span");return t.innerHTML="close",e.append(t),e}function E(){let e=document.createElement("button");return e.classList.add("button-primary"),e.innerHTML="submit",e}function g(){let e=document.createElement("input");return e.type="number",e.name="qty",e.id="id_qty",e.required=!0,e.min=1,e}const h="add-slot",b="editor-slot-filler-quantity",_="excess-modules",S="filled",q="bucket-item",T="module-slot",w="editing",$="empty",M="module-bucket-container",k="new-slot-filler-inputs",H="modular-item-container",A="product_desc",j="modular-slot-container",x="id_submit_new",I="id_submit_qty_edit";function R(e){if(e.classList.contains(j))var t=e;else t=e.closest("."+j);return null===t?null:{slot:t.dataset.slot,parent:t.dataset.parent}}function F(e,t){for(let n=0;n<t.length;n++)if(void 0===e[t[n]])return!1;return!0}function N(){let e=document.createElement("div");e.classList.add(T),e.classList.add($);let t=document.createElement("i");return t.innerHTML="Click to fill",e.append(t),e.addEventListener("click",(e=>{U(e)})),e}async function U(e){let t=(i=e.target).classList.contains($)?i:i.closest("."+T+"."+$);var i;let l=R(e.target),s=await async function(e,t){let i=function(){let e=document.createElement("div");return e.classList.add(M),e.classList.add(n),e.classList.add(r),e.classList.add("popout"),e}();i.append(function(){let e=y();return e.addEventListener("click",(()=>{document.querySelector("."+M).remove()})),e}());let l=await C(e,t,"jobitems");if(!L(l,200))return i.append(V(l,"Failed to load.")),i;const s="parent_quantity";return F(l,[s,"opt_list"])?(i.append(function(e){let t=document.createElement("h4");return t.classList.add(a),t.innerHTML=`Assign ${e} x ...`,t}(l[s])),i.append(function(e){let t=e.opt_list;if(0===t.length){let e=document.createElement("p");return e.innerHTML="There are no unassigned items on this job which are suitable for this slot.",e}let n=document.createElement("div");n.classList.add("bucket-options-container");for(var a=0;a<t.length;a++){var r=G(t[a],parseInt(e.parent_quantity));n.append(r)}return n}(l)),i.append(function(){let e=document.createElement("button");return e.innerHTML="new item to job",e.classList.add("add-button"),e.classList.add("module"),e.addEventListener("click",(e=>{!async function(e){let t=e.target.closest("."+M),n=t.previousSibling,a=R(e.target),r=await async function(e,t){let n=function(){let e=document.createElement("div");return e.classList.add(T),e.classList.add(k),e}();n.append(function(){let e=document.createElement("H5");return e.innerHTML="Fill slot with new item",e}()),n.append(function(){let e=y();return e.addEventListener("click",(e=>{!function(e){let t=e.closest("."+T),n=N();t.after(n),t.remove()}(e.target)})),e}());let a=await C(e,t,"products");if(L(a,200)&&void 0!==a.opt_list)return n.append(function(e){let t=document.createElement("select");t.name="product";for(let r=0;r<e.length;r++){var n=e[r],a=document.createElement("option");a.value=n.id,a.innerHTML=`${n.name} @ ${n.price_f}`,t.append(a)}return t}(a.opt_list)),n.append(function(){let e=document.createElement("div");e.classList.add("combo-input-and-button");let t=g();return t.value=1,e.append(t),e.append(function(){let e=E();return e.id=x,e.addEventListener("click",(e=>{!async function(e){let t=R(e.target),n=e.target.closest(`.${k}`),a=n.querySelector('input[name="qty"]').value,r=n.lastChild,i=await async function(e,t,n,a,r){let i=a*e.target.closest(`.${H}`).dataset.quantity,l=t.querySelector("select").value,s=await async function(e,t,n){let a=u("POST",{quantity:t,product:n,parent:e});return await p(URL_ITEMS,a)}(n.parent,i,l);if(!L(s,201))return Q(r,s,"Failed to add new item to job."),null;let o=s.id;return void 0===o?(Q(r,"Error: item not assigned to slot."),null):o}(e,n,t,a,r);if(null===i)return;let l=await async function(e,t,n){let a=`${URL_ITEMS}?ji_id=${e}`,r=await m(a);return L(r,200)?r:(Q(t,r,n),null)}(i,r,"Failed to fill slot. Try refreshing the page.");if(null===l)return;const s="product_id";if("undefined"===l[s])return void Q(r,failed_task_text);let o=await D(l[s],t,a,r);var c;null!==o&&(O(o,a,`${a} x ${(c=n.querySelector("select")).options[c.selectedIndex].text.match(/^.+(?=( @ ))/)[0]}`,n),n.remove())}(e)})),e}()),e}()),n;n.append(V(a,"Failed to load dropdown."))}(a.slot,a.parent);n.after(r),n.remove(),t.remove()}(e)})),e}()),i):(i.append(V("Failed to load.")),i)}(l.slot,l.parent);t.after(s),W()}async function C(e,t,n){let a=`${URL_GENERAL_API}?type=select_options_list&name=slot_options_${n}&parent=${t}&slot=${e}`;return await m(a)}function G(e,t){var n=document.createElement("div");n.classList.add(q);const a="name",r="quantity_available",i="quantity_total";return F(e,["id",a,r,i])?(n.setAttribute("data-child",e.id),t>parseInt(e[r])?n.classList.add("jobitem_usedup"):(n.classList.add("jobitem"),n.addEventListener("click",(e=>{!async function(e){let t=R(e.target),n=(l=e.target).classList.contains(q)?l:l.closest(`.${q}`),a=e.target.closest("."+M),r=a.previousSibling,i=await D(n.dataset.child,t,1,r);var l;null!==i&&(O(i,1,`${e.target.closest(`.${H}`).dataset.quantity} x ${n.querySelector(`.${A}`).innerHTML}`,r),r.remove()),a.remove()}(e)}))),n.append(function(e){let t=document.createElement("span");return t.classList.add(A),t.innerHTML=e,t}(e[a])),n.append(function(e,t){let n=document.createElement("div");return n.classList.add("availability"),n.innerHTML=`${e}/${t} available`,n}(e[r],e[i])),n):(n.innerHTML="Error: failed to load",n)}function O(t,n,a,r){if(void 0===t)return void Q(r,"Display error: try refreshing the page.");let l=function(t,n,a){let r=document.createElement("div");return r.classList.add(T),r.classList.add("jobitem"),r.append(function(e){let t=function(){let e=document.createElement("button");e.classList.add(i);let t=document.createElement("span");return t.innerHTML="edit",e.append(t),e}();return t.setAttribute("data-jobmod",e),t.addEventListener("click",(e=>{P(e)})),t}(a)),r.append(function(t,n){let a=e,r=document.createElement("span");return r.classList.add("child-desc"),r.innerHTML=t.replace(a,n),r}(t,n)),r}(a,n,t);r.after(l),X(l)}async function D(e,t,n,a){let r=await async function(e,t,n){let a=u("POST",{parent:t,child:e,slot:n,quantity:arguments.length>3&&void 0!==arguments[3]?arguments[3]:1});return await p(URL_ASSIGNMENTS,a)}(e,t.parent,t.slot,n);if(!L(r))return Q(a,r,"Failed to assign item to slot."),null;let i=r.id;return void 0===i?(Q(a,"Display error: try refreshing the page."),null):i}function P(t){let n=t.target.closest(`.${T}`),a=n.querySelector(".child-desc"),r=t.target.dataset.jobmod,s=a.innerHTML;n.prepend(function(t,n){let a=document.createElement("div");return a.classList.add(b),a.append(function(){let e=y();return e.classList.add("close-edit-mode"),e.addEventListener("click",(e=>{B(e.target)})),e}()),a.append(function(e){let t=document.createElement("span");return t.classList.add("desc"),t.innerHTML=function(e){return e.trim().replace(/^.+( x )/,"")}(e),t}(n)),a.append(function(e){let t=document.createElement("button");t.classList.add("delete-panel");let n=document.createElement("span");return n.innerHTML="unassign",t.append(n),t.setAttribute("data-jobmod",e),t.addEventListener("click",(e=>{!async function(e){let t=await async function(e){let t=u("DELETE");return await p(`${URL_ASSIGNMENTS}?id=${e.target.dataset.jobmod}`,t)}(e);L(t)?function(e){let t=N(),n=e.target.closest(`.${T}`);n.after(t),n.remove(),X(t),B(e.target)}(e):Q(document.getElementById(I),t,"Failed to empty slot.")}(e)})),t}(t)),a.append(function(t,n){let a=document.createElement("span");return a.classList.add("combo-input-and-button"),a.append(function(t,n){let a=g();return a.value=n.match(e),a.setAttribute("data-id",t),a.setAttribute("data-prev_qty",n.match(e)),a.addEventListener("keydown",(e=>{"Enter"===e.key&&J(e.target)})),a}(t,n)),a.append(function(){let e=E();return e.id=I,e.addEventListener("click",(e=>{J(e.target.previousSibling)})),e}()),a}(t,n)),a}(r,s)),a.innerHTML=s.replace(e,""),n.classList.add(w),a.classList.add(l),v(i),v("remove-from-slot-btn")}function B(e,t){let n=e.closest(`.${T}`),a=n.querySelector("input").dataset.prev_qty;void 0!==t&&(a=t);let r=n.querySelector(`.${b}`);r&&r.remove();let s=n.querySelector(".child-desc");var o;s.innerHTML=a+s.innerHTML,s.classList.contains(l)&&s.classList.remove(l),n.classList.contains(w)&&n.classList.remove(w),o=i,document.querySelectorAll("."+o).forEach((e=>{e.classList.remove(l)})),W()}async function J(e){let t=await async function(e){let t=u("PUT",{qty:e.value,prev_qty:e.dataset.prev_qty,id:e.dataset.id});return await p(URL_ASSIGNMENTS,t)}(e);L(t,204)?function(e,t){""===e.value||parseFloat(e.value)<=0?B(e):(X(e),B(e,e.value))}(e,e.dataset.id):Q(e.parentElement,data)}async function X(e){let t=e.closest(`.${j}`).querySelector(`.${h}`),n="Refresh page to update slot status.",a=await async function(e,t,n){let a=R(e),r=`${URL_ASSIGNMENTS}?parent_id=${a.parent}&slot_id=${a.slot}`,i=await m(r);return L(i,200)?i:(Q(t,i,n),null)}(e,t,n);if(null===a)return;const r="required_str",i="optional_str",l="slot_num_excess",s="jobitem_has_excess";F(a,[r,i,l,s])?function(e,t,n,a,r){let i=e.closest(`.${j}`);K(i,"required",t),K(i,"optional",n),function(e,t,n){let a=null!==e.querySelector("."+t),r=parseInt(n)>0;if(r||!a)if(!r||a)r&&a&&(e.querySelector("."+t).querySelector(".body").innerHTML=n);else{let t=function(e){let t=document.createElement("div");t.classList.add("excess");let n=document.createElement("span");n.classList.add("head"),n.innerHTML="excess",t.append(n);let a=document.createElement("span");return a.classList.add("body"),a.innerHTML=e,t.append(a),t}(n);e.querySelector(".slot-info").append(t)}else e.querySelector("."+t).remove()}(i,"excess",a),z(e.closest(".subsection"),_,parseInt(a)>0),z(e.closest(`.${H}`),_,r)}(e,a[r],a[i],a[l],a[s]):Q(t,n)}function z(e,t,n){let a=e.classList.contains(t);n&&!a?e.classList.add(t):!n&&a&&e.classList.remove(t)}function K(e,t,n){let a=e.querySelector("."+t);a.querySelector(".body").innerHTML=n;const r=function(e){let t=e.split("/");return t[0]===t[1]}(n);z(a,S,r)}function Q(e,t){let n=V(t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:null);e.after(n)}function V(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=document.createElement("div");return a.classList.add(t),a.innerHTML=get_error_message(e,n),a}function W(){document.querySelectorAll("."+t).forEach((e=>{e.remove()}))}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll("."+T+"."+$).forEach((e=>{e.addEventListener("click",(e=>{U(e)}))})),document.querySelectorAll(`.${h}`).forEach((e=>{e.addEventListener("click",(e=>{!function(e){let t=e.target.closest("."+j).querySelector(".contents"),n=N();t.append(n)}(e)}))})),document.querySelectorAll(".edit-slot-filler-btn").forEach((e=>{e.addEventListener("click",(e=>{P(e)}))}))}))})();